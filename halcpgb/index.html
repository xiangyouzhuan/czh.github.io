<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.4">
<meta name="author" content="Fifi Lyu">
<title>高可用负载均衡集群实践简明教程: High-Availability Loadbalancing Clusters Practice Guide for Beginners</title>
<style>
/*! normalize.css v2.1.2 | MIT License | git.io/normalize */
/* ========================================================================== HTML5 display definitions ========================================================================== */
/** Correct `block` display not defined in IE 8/9. */
article, aside, details, figcaption, figure, footer, header, hgroup, main, nav, section, summary { display: block; }

/** Correct `inline-block` display not defined in IE 8/9. */
audio, canvas, video { display: inline-block; }

/** Prevent modern browsers from displaying `audio` without controls. Remove excess height in iOS 5 devices. */
audio:not([controls]) { display: none; height: 0; }

/** Address `[hidden]` styling not present in IE 8/9. Hide the `template` element in IE, Safari, and Firefox < 22. */
[hidden], template { display: none; }

script { display: none !important; }

/* ========================================================================== Base ========================================================================== */
/** 1. Set default font family to sans-serif. 2. Prevent iOS text size adjust after orientation change, without disabling user zoom. */
html { font-family: sans-serif; /* 1 */ -ms-text-size-adjust: 100%; /* 2 */ -webkit-text-size-adjust: 100%; /* 2 */ }

/** Remove default margin. */
body { margin: 0; }

/* ========================================================================== Links ========================================================================== */
/** Remove the gray background color from active links in IE 10. */
a { background: transparent; }

/** Address `outline` inconsistency between Chrome and other browsers. */
a:focus { outline: thin dotted; }

/** Improve readability when focused and also mouse hovered in all browsers. */
a:active, a:hover { outline: 0; }

/* ========================================================================== Typography ========================================================================== */
/** Address variable `h1` font-size and margin within `section` and `article` contexts in Firefox 4+, Safari 5, and Chrome. */
h1 { font-size: 2em; margin: 0.67em 0; }

/** Address styling not present in IE 8/9, Safari 5, and Chrome. */
abbr[title] { border-bottom: 1px dotted; }

/** Address style set to `bolder` in Firefox 4+, Safari 5, and Chrome. */
b, strong { font-weight: bold; }

/** Address styling not present in Safari 5 and Chrome. */
dfn { font-style: italic; }

/** Address differences between Firefox and other browsers. */
hr { -moz-box-sizing: content-box; box-sizing: content-box; height: 0; }

/** Address styling not present in IE 8/9. */
mark { background: #ff0; color: #000; }

/** Correct font family set oddly in Safari 5 and Chrome. */
code, kbd, pre, samp { font-family: monospace, serif; font-size: 1em; }

/** Improve readability of pre-formatted text in all browsers. */
pre { white-space: pre-wrap; }

/** Set consistent quote types. */
q { quotes: "\201C" "\201D" "\2018" "\2019"; }

/** Address inconsistent and variable font size in all browsers. */
small { font-size: 80%; }

/** Prevent `sub` and `sup` affecting `line-height` in all browsers. */
sub, sup { font-size: 75%; line-height: 0; position: relative; vertical-align: baseline; }

sup { top: -0.5em; }

sub { bottom: -0.25em; }

/* ========================================================================== Embedded content ========================================================================== */
/** Remove border when inside `a` element in IE 8/9. */
img { border: 0; }

/** Correct overflow displayed oddly in IE 9. */
svg:not(:root) { overflow: hidden; }

/* ========================================================================== Figures ========================================================================== */
/** Address margin not present in IE 8/9 and Safari 5. */
figure { margin: 0; }

/* ========================================================================== Forms ========================================================================== */
/** Define consistent border, margin, and padding. */
fieldset { border: 1px solid #c0c0c0; margin: 0 2px; padding: 0.35em 0.625em 0.75em; }

/** 1. Correct `color` not being inherited in IE 8/9. 2. Remove padding so people aren't caught out if they zero out fieldsets. */
legend { border: 0; /* 1 */ padding: 0; /* 2 */ }

/** 1. Correct font family not being inherited in all browsers. 2. Correct font size not being inherited in all browsers. 3. Address margins set differently in Firefox 4+, Safari 5, and Chrome. */
button, input, select, textarea { font-family: inherit; /* 1 */ font-size: 100%; /* 2 */ margin: 0; /* 3 */ }

/** Address Firefox 4+ setting `line-height` on `input` using `!important` in the UA stylesheet. */
button, input { line-height: normal; }

/** Address inconsistent `text-transform` inheritance for `button` and `select`. All other form control elements do not inherit `text-transform` values. Correct `button` style inheritance in Chrome, Safari 5+, and IE 8+. Correct `select` style inheritance in Firefox 4+ and Opera. */
button, select { text-transform: none; }

/** 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio` and `video` controls. 2. Correct inability to style clickable `input` types in iOS. 3. Improve usability and consistency of cursor style between image-type `input` and others. */
button, html input[type="button"], input[type="reset"], input[type="submit"] { -webkit-appearance: button; /* 2 */ cursor: pointer; /* 3 */ }

/** Re-set default cursor for disabled elements. */
button[disabled], html input[disabled] { cursor: default; }

/** 1. Address box sizing set to `content-box` in IE 8/9. 2. Remove excess padding in IE 8/9. */
input[type="checkbox"], input[type="radio"] { box-sizing: border-box; /* 1 */ padding: 0; /* 2 */ }

/** 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome. 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome (include `-moz` to future-proof). */
input[type="search"] { -webkit-appearance: textfield; /* 1 */ -moz-box-sizing: content-box; -webkit-box-sizing: content-box; /* 2 */ box-sizing: content-box; }

/** Remove inner padding and search cancel button in Safari 5 and Chrome on OS X. */
input[type="search"]::-webkit-search-cancel-button, input[type="search"]::-webkit-search-decoration { -webkit-appearance: none; }

/** Remove inner padding and border in Firefox 4+. */
button::-moz-focus-inner, input::-moz-focus-inner { border: 0; padding: 0; }

/** 1. Remove default vertical scrollbar in IE 8/9. 2. Improve readability and alignment in all browsers. */
textarea { overflow: auto; /* 1 */ vertical-align: top; /* 2 */ }

/* ========================================================================== Tables ========================================================================== */
/** Remove most spacing between table cells. */
table { border-collapse: collapse; border-spacing: 0; }

meta.foundation-mq-small { font-family: "only screen and (min-width: 768px)"; width: 768px; }

meta.foundation-mq-medium { font-family: "only screen and (min-width:1280px)"; width: 1280px; }

meta.foundation-mq-large { font-family: "only screen and (min-width:1440px)"; width: 1440px; }

*, *:before, *:after { -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }

html, body { font-size: 100%; }

body { background: white; color: rgba(0, 0, 0, 0.8); padding: 0; margin: 0; font-family: "Noto Serif", "DejaVu Serif", serif; font-weight: normal; font-style: normal; line-height: 1; position: relative; cursor: auto; }

a:hover { cursor: pointer; }

img, object, embed { max-width: 100%; height: auto; }

object, embed { height: 100%; }

img { -ms-interpolation-mode: bicubic; }

#map_canvas img, #map_canvas embed, #map_canvas object, .map_canvas img, .map_canvas embed, .map_canvas object { max-width: none !important; }

.left { float: left !important; }

.right { float: right !important; }

.text-left { text-align: left !important; }

.text-right { text-align: right !important; }

.text-center { text-align: center !important; }

.text-justify { text-align: justify !important; }

.hide { display: none; }

.antialiased, body { -webkit-font-smoothing: antialiased; }

img { display: inline-block; vertical-align: middle; }

textarea { height: auto; min-height: 50px; }

select { width: 100%; }

object, svg { display: inline-block; vertical-align: middle; }

.center { margin-left: auto; margin-right: auto; }

.spread { width: 100%; }

p.lead, .paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { font-size: 1.21875em; line-height: 1.6; }

.subheader, .admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { line-height: 1.45; color: #7a2518; font-weight: normal; margin-top: 0; margin-bottom: 0.25em; }

/* Typography resets */
div, dl, dt, dd, ul, ol, li, h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6, pre, form, p, blockquote, th, td { margin: 0; padding: 0; direction: ltr; }

/* Default Link Styles */
a { color: #2156a5; text-decoration: underline; line-height: inherit; }
a:hover, a:focus { color: #1d4b8f; }
a img { border: none; }

/* Default paragraph styles */
p { font-family: inherit; font-weight: normal; font-size: 1em; line-height: 1.6; margin-bottom: 1.25em; text-rendering: optimizeLegibility; }
p aside { font-size: 0.875em; line-height: 1.35; font-style: italic; }

/* Default header styles */
h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { font-family: "Open Sans", "DejaVu Sans", sans-serif; font-weight: 300; font-style: normal; color: #ba3925; text-rendering: optimizeLegibility; margin-top: 1em; margin-bottom: 0.5em; line-height: 1.0125em; }
h1 small, h2 small, h3 small, #toctitle small, .sidebarblock > .content > .title small, h4 small, h5 small, h6 small { font-size: 60%; color: #e99b8f; line-height: 0; }

h1 { font-size: 2.125em; }

h2 { font-size: 1.6875em; }

h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.375em; }

h4 { font-size: 1.125em; }

h5 { font-size: 1.125em; }

h6 { font-size: 1em; }

hr { border: solid #ddddd8; border-width: 1px 0 0; clear: both; margin: 1.25em 0 1.1875em; height: 0; }

/* Helpful Typography Defaults */
em, i { font-style: italic; line-height: inherit; }

strong, b { font-weight: bold; line-height: inherit; }

small { font-size: 60%; line-height: inherit; }

code { font-family: "Droid Sans Mono", "DejaVu Sans Mono", monospace; font-weight: normal; color: rgba(0, 0, 0, 0.9); }

/* Lists */
ul, ol, dl { font-size: 1em; line-height: 1.6; margin-bottom: 1.25em; list-style-position: outside; font-family: inherit; }

ul, ol { margin-left: 1.5em; }
ul.no-bullet, ol.no-bullet { margin-left: 1.5em; }

/* Unordered Lists */
ul li ul, ul li ol { margin-left: 1.25em; margin-bottom: 0; font-size: 1em; /* Override nested font-size change */ }
ul.square li ul, ul.circle li ul, ul.disc li ul { list-style: inherit; }
ul.square { list-style-type: square; }
ul.circle { list-style-type: circle; }
ul.disc { list-style-type: disc; }
ul.no-bullet { list-style: none; }

/* Ordered Lists */
ol li ul, ol li ol { margin-left: 1.25em; margin-bottom: 0; }

/* Definition Lists */
dl dt { margin-bottom: 0.3125em; font-weight: bold; }
dl dd { margin-bottom: 1.25em; }

/* Abbreviations */
abbr, acronym { text-transform: uppercase; font-size: 90%; color: rgba(0, 0, 0, 0.8); border-bottom: 1px dotted #dddddd; cursor: help; }

abbr { text-transform: none; }

/* Blockquotes */
blockquote { margin: 0 0 1.25em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #dddddd; }
blockquote cite { display: block; font-size: 0.9375em; color: rgba(0, 0, 0, 0.6); }
blockquote cite:before { content: "\2014 \0020"; }
blockquote cite a, blockquote cite a:visited { color: rgba(0, 0, 0, 0.6); }

blockquote, blockquote p { line-height: 1.6; color: rgba(0, 0, 0, 0.85); }

/* Microformats */
.vcard { display: inline-block; margin: 0 0 1.25em 0; border: 1px solid #dddddd; padding: 0.625em 0.75em; }
.vcard li { margin: 0; display: block; }
.vcard .fn { font-weight: bold; font-size: 0.9375em; }

.vevent .summary { font-weight: bold; }
.vevent abbr { cursor: auto; text-decoration: none; font-weight: bold; border: none; padding: 0 0.0625em; }

@media only screen and (min-width: 768px) { h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.2; }
  h1 { font-size: 2.75em; }
  h2 { font-size: 2.3125em; }
  h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.6875em; }
  h4 { font-size: 1.4375em; } }
/* Tables */
table { background: white; margin-bottom: 1.25em; border: solid 1px #dedede; }
table thead, table tfoot { background: #f7f8f7; font-weight: bold; }
table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td { padding: 0.5em 0.625em 0.625em; font-size: inherit; color: rgba(0, 0, 0, 0.8); text-align: left; }
table tr th, table tr td { padding: 0.5625em 0.625em; font-size: inherit; color: rgba(0, 0, 0, 0.8); }
table tr.even, table tr.alt, table tr:nth-of-type(even) { background: #f8f8f7; }
table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td { display: table-cell; line-height: 1.6; }

body { tab-size: 4; }

h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.2; word-spacing: -0.05em; }
h1 strong, h2 strong, h3 strong, #toctitle strong, .sidebarblock > .content > .title strong, h4 strong, h5 strong, h6 strong { font-weight: 400; }

.clearfix:before, .clearfix:after, .float-group:before, .float-group:after { content: " "; display: table; }
.clearfix:after, .float-group:after { clear: both; }

*:not(pre) > code { font-size: 0.9375em; font-style: normal !important; letter-spacing: 0; padding: 0.1em 0.5ex; word-spacing: -0.15em; background-color: #f7f7f8; -webkit-border-radius: 4px; border-radius: 4px; line-height: 1.45; text-rendering: optimizeSpeed; }

pre, pre > code { line-height: 1.45; color: rgba(0, 0, 0, 0.9); font-family: "Droid Sans Mono", "DejaVu Sans Mono", "Monospace", monospace; font-weight: normal; text-rendering: optimizeSpeed; }

.keyseq { color: rgba(51, 51, 51, 0.8); }

kbd { font-family: "Droid Sans Mono", "DejaVu Sans Mono", monospace; display: inline-block; color: rgba(0, 0, 0, 0.8); font-size: 0.65em; line-height: 1.45; background-color: #f7f7f7; border: 1px solid #ccc; -webkit-border-radius: 3px; border-radius: 3px; -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset; box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset; margin: 0 0.15em; padding: 0.2em 0.5em; vertical-align: middle; position: relative; top: -0.1em; white-space: nowrap; }

.keyseq kbd:first-child { margin-left: 0; }

.keyseq kbd:last-child { margin-right: 0; }

.menuseq, .menu { color: rgba(0, 0, 0, 0.8); }

b.button:before, b.button:after { position: relative; top: -1px; font-weight: normal; }

b.button:before { content: "["; padding: 0 3px 0 2px; }

b.button:after { content: "]"; padding: 0 2px 0 3px; }

p a > code:hover { color: rgba(0, 0, 0, 0.9); }

#header, #content, #footnotes, #footer { width: 100%; margin-left: auto; margin-right: auto; margin-top: 0; margin-bottom: 0; max-width: 62.5em; *zoom: 1; position: relative; padding-left: 0.9375em; padding-right: 0.9375em; }
#header:before, #header:after, #content:before, #content:after, #footnotes:before, #footnotes:after, #footer:before, #footer:after { content: " "; display: table; }
#header:after, #content:after, #footnotes:after, #footer:after { clear: both; }

#content { margin-top: 1.25em; }

#content:before { content: none; }

#header > h1:first-child { color: rgba(0, 0, 0, 0.85); margin-top: 2.25rem; margin-bottom: 0; }
#header > h1:first-child + #toc { margin-top: 8px; border-top: 1px solid #ddddd8; }
#header > h1:only-child, body.toc2 #header > h1:nth-last-child(2) { border-bottom: 1px solid #ddddd8; padding-bottom: 8px; }
#header .details { border-bottom: 1px solid #ddddd8; line-height: 1.45; padding-top: 0.25em; padding-bottom: 0.25em; padding-left: 0.25em; color: rgba(0, 0, 0, 0.6); display: -ms-flexbox; display: -webkit-flex; display: flex; -ms-flex-flow: row wrap; -webkit-flex-flow: row wrap; flex-flow: row wrap; }
#header .details span:first-child { margin-left: -0.125em; }
#header .details span.email a { color: rgba(0, 0, 0, 0.85); }
#header .details br { display: none; }
#header .details br + span:before { content: "\00a0\2013\00a0"; }
#header .details br + span.author:before { content: "\00a0\22c5\00a0"; color: rgba(0, 0, 0, 0.85); }
#header .details br + span#revremark:before { content: "\00a0|\00a0"; }
#header #revnumber { text-transform: capitalize; }
#header #revnumber:after { content: "\00a0"; }

#content > h1:first-child:not([class]) { color: rgba(0, 0, 0, 0.85); border-bottom: 1px solid #ddddd8; padding-bottom: 8px; margin-top: 0; padding-top: 1rem; margin-bottom: 1.25rem; }

#toc { border-bottom: 1px solid #efefed; padding-bottom: 0.5em; }
#toc > ul { margin-left: 0.125em; }
#toc ul.sectlevel0 > li > a { font-style: italic; }
#toc ul.sectlevel0 ul.sectlevel1 { margin: 0.5em 0; }
#toc ul { font-family: "Open Sans", "DejaVu Sans", sans-serif; list-style-type: none; }
#toc li { line-height: 1.3334; margin-top: 0.3334em; }
#toc a { text-decoration: none; }
#toc a:active { text-decoration: underline; }

#toctitle { color: #7a2518; font-size: 1.2em; }

@media only screen and (min-width: 768px) { #toctitle { font-size: 1.375em; }
  body.toc2 { padding-left: 15em; padding-right: 0; }
  #toc.toc2 { margin-top: 0 !important; background-color: #f8f8f7; position: fixed; width: 15em; left: 0; top: 0; border-right: 1px solid #efefed; border-top-width: 0 !important; border-bottom-width: 0 !important; z-index: 1000; padding: 1.25em 1em; height: 100%; overflow: auto; }
  #toc.toc2 #toctitle { margin-top: 0; margin-bottom: 0.8rem; font-size: 1.2em; }
  #toc.toc2 > ul { font-size: 0.9em; margin-bottom: 0; }
  #toc.toc2 ul ul { margin-left: 0; padding-left: 1em; }
  #toc.toc2 ul.sectlevel0 ul.sectlevel1 { padding-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 15em; }
  body.toc2.toc-right #toc.toc2 { border-right-width: 0; border-left: 1px solid #efefed; left: auto; right: 0; } }
@media only screen and (min-width: 1280px) { body.toc2 { padding-left: 20em; padding-right: 0; }
  #toc.toc2 { width: 20em; }
  #toc.toc2 #toctitle { font-size: 1.375em; }
  #toc.toc2 > ul { font-size: 0.95em; }
  #toc.toc2 ul ul { padding-left: 1.25em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 20em; } }
#content #toc { border-style: solid; border-width: 1px; border-color: #e0e0dc; margin-bottom: 1.25em; padding: 1.25em; background: #f8f8f7; -webkit-border-radius: 4px; border-radius: 4px; }
#content #toc > :first-child { margin-top: 0; }
#content #toc > :last-child { margin-bottom: 0; }

#footer { max-width: 100%; background-color: rgba(0, 0, 0, 0.8); padding: 1.25em; }

#footer-text { color: rgba(255, 255, 255, 0.8); line-height: 1.44; }

.sect1 { padding-bottom: 0.625em; }

@media only screen and (min-width: 768px) { .sect1 { padding-bottom: 1.25em; } }
.sect1 + .sect1 { border-top: 1px solid #efefed; }

#content h1 > a.anchor, h2 > a.anchor, h3 > a.anchor, #toctitle > a.anchor, .sidebarblock > .content > .title > a.anchor, h4 > a.anchor, h5 > a.anchor, h6 > a.anchor { position: absolute; z-index: 1001; width: 1.5ex; margin-left: -1.5ex; display: block; text-decoration: none !important; visibility: hidden; text-align: center; font-weight: normal; }
#content h1 > a.anchor:before, h2 > a.anchor:before, h3 > a.anchor:before, #toctitle > a.anchor:before, .sidebarblock > .content > .title > a.anchor:before, h4 > a.anchor:before, h5 > a.anchor:before, h6 > a.anchor:before { content: "\00A7"; font-size: 0.85em; display: block; padding-top: 0.1em; }
#content h1:hover > a.anchor, #content h1 > a.anchor:hover, h2:hover > a.anchor, h2 > a.anchor:hover, h3:hover > a.anchor, #toctitle:hover > a.anchor, .sidebarblock > .content > .title:hover > a.anchor, h3 > a.anchor:hover, #toctitle > a.anchor:hover, .sidebarblock > .content > .title > a.anchor:hover, h4:hover > a.anchor, h4 > a.anchor:hover, h5:hover > a.anchor, h5 > a.anchor:hover, h6:hover > a.anchor, h6 > a.anchor:hover { visibility: visible; }
#content h1 > a.link, h2 > a.link, h3 > a.link, #toctitle > a.link, .sidebarblock > .content > .title > a.link, h4 > a.link, h5 > a.link, h6 > a.link { color: #ba3925; text-decoration: none; }
#content h1 > a.link:hover, h2 > a.link:hover, h3 > a.link:hover, #toctitle > a.link:hover, .sidebarblock > .content > .title > a.link:hover, h4 > a.link:hover, h5 > a.link:hover, h6 > a.link:hover { color: #a53221; }

.audioblock, .imageblock, .literalblock, .listingblock, .stemblock, .videoblock { margin-bottom: 1.25em; }

.admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { text-rendering: optimizeLegibility; text-align: left; font-family: "Noto Serif", "DejaVu Serif", serif; font-size: 1rem; font-style: italic; }

table.tableblock > caption.title { white-space: nowrap; overflow: visible; max-width: 0; }

.paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { color: rgba(0, 0, 0, 0.85); }

table.tableblock #preamble > .sectionbody > .paragraph:first-of-type p { font-size: inherit; }

.admonitionblock > table { border-collapse: separate; border: 0; background: none; width: 100%; }
.admonitionblock > table td.icon { text-align: center; width: 80px; }
.admonitionblock > table td.icon img { max-width: none; }
.admonitionblock > table td.icon .title { font-weight: bold; font-family: "Open Sans", "DejaVu Sans", sans-serif; text-transform: uppercase; }
.admonitionblock > table td.content { padding-left: 1.125em; padding-right: 1.25em; border-left: 1px solid #ddddd8; color: rgba(0, 0, 0, 0.6); }
.admonitionblock > table td.content > :last-child > :last-child { margin-bottom: 0; }

.exampleblock > .content { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.25em; padding: 1.25em; background: white; -webkit-border-radius: 4px; border-radius: 4px; }
.exampleblock > .content > :first-child { margin-top: 0; }
.exampleblock > .content > :last-child { margin-bottom: 0; }

.sidebarblock { border-style: solid; border-width: 1px; border-color: #e0e0dc; margin-bottom: 1.25em; padding: 1.25em; background: #f8f8f7; -webkit-border-radius: 4px; border-radius: 4px; }
.sidebarblock > :first-child { margin-top: 0; }
.sidebarblock > :last-child { margin-bottom: 0; }
.sidebarblock > .content > .title { color: #7a2518; margin-top: 0; text-align: center; }

.exampleblock > .content > :last-child > :last-child, .exampleblock > .content .olist > ol > li:last-child > :last-child, .exampleblock > .content .ulist > ul > li:last-child > :last-child, .exampleblock > .content .qlist > ol > li:last-child > :last-child, .sidebarblock > .content > :last-child > :last-child, .sidebarblock > .content .olist > ol > li:last-child > :last-child, .sidebarblock > .content .ulist > ul > li:last-child > :last-child, .sidebarblock > .content .qlist > ol > li:last-child > :last-child { margin-bottom: 0; }

.literalblock pre, .listingblock pre:not(.highlight), .listingblock pre[class="highlight"], .listingblock pre[class^="highlight "], .listingblock pre.CodeRay, .listingblock pre.prettyprint { background: #f7f7f8; }
.sidebarblock .literalblock pre, .sidebarblock .listingblock pre:not(.highlight), .sidebarblock .listingblock pre[class="highlight"], .sidebarblock .listingblock pre[class^="highlight "], .sidebarblock .listingblock pre.CodeRay, .sidebarblock .listingblock pre.prettyprint { background: #f2f1f1; }

.literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { -webkit-border-radius: 4px; border-radius: 4px; word-wrap: break-word; padding: 1em; font-size: 0.8125em; }
.literalblock pre.nowrap, .literalblock pre[class].nowrap, .listingblock pre.nowrap, .listingblock pre[class].nowrap { overflow-x: auto; white-space: pre; word-wrap: normal; }
@media only screen and (min-width: 768px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 0.90625em; } }
@media only screen and (min-width: 1280px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 1em; } }

.literalblock.output pre { color: #f7f7f8; background-color: rgba(0, 0, 0, 0.9); }

.listingblock pre.highlightjs { padding: 0; }
.listingblock pre.highlightjs > code { padding: 1em; -webkit-border-radius: 4px; border-radius: 4px; }

.listingblock pre.prettyprint { border-width: 0; }

.listingblock > .content { position: relative; }

.listingblock code[data-lang]:before { display: none; content: attr(data-lang); position: absolute; font-size: 0.75em; top: 0.425rem; right: 0.5rem; line-height: 1; text-transform: uppercase; color: #999; }

.listingblock:hover code[data-lang]:before { display: block; }

.listingblock.terminal pre .command:before { content: attr(data-prompt); padding-right: 0.5em; color: #999; }

.listingblock.terminal pre .command:not([data-prompt]):before { content: "$"; }

table.pyhltable { border-collapse: separate; border: 0; margin-bottom: 0; background: none; }

table.pyhltable td { vertical-align: top; padding-top: 0; padding-bottom: 0; line-height: 1.45; }

table.pyhltable td.code { padding-left: .75em; padding-right: 0; }

pre.pygments .lineno, table.pyhltable td:not(.code) { color: #999; padding-left: 0; padding-right: .5em; border-right: 1px solid #ddddd8; }

pre.pygments .lineno { display: inline-block; margin-right: .25em; }

table.pyhltable .linenodiv { background: none !important; padding-right: 0 !important; }

.quoteblock { margin: 0 1em 1.25em 1.5em; display: table; }
.quoteblock > .title { margin-left: -1.5em; margin-bottom: 0.75em; }
.quoteblock blockquote, .quoteblock blockquote p { color: rgba(0, 0, 0, 0.85); font-size: 1.15rem; line-height: 1.75; word-spacing: 0.1em; letter-spacing: 0; font-style: italic; text-align: justify; }
.quoteblock blockquote { margin: 0; padding: 0; border: 0; }
.quoteblock blockquote:before { content: "\201c"; float: left; font-size: 2.75em; font-weight: bold; line-height: 0.6em; margin-left: -0.6em; color: #7a2518; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); }
.quoteblock blockquote > .paragraph:last-child p { margin-bottom: 0; }
.quoteblock .attribution { margin-top: 0.5em; margin-right: 0.5ex; text-align: right; }
.quoteblock .quoteblock { margin-left: 0; margin-right: 0; padding: 0.5em 0; border-left: 3px solid rgba(0, 0, 0, 0.6); }
.quoteblock .quoteblock blockquote { padding: 0 0 0 0.75em; }
.quoteblock .quoteblock blockquote:before { display: none; }

.verseblock { margin: 0 1em 1.25em 1em; }
.verseblock pre { font-family: "Open Sans", "DejaVu Sans", sans; font-size: 1.15rem; color: rgba(0, 0, 0, 0.85); font-weight: 300; text-rendering: optimizeLegibility; }
.verseblock pre strong { font-weight: 400; }
.verseblock .attribution { margin-top: 1.25rem; margin-left: 0.5ex; }

.quoteblock .attribution, .verseblock .attribution { font-size: 0.9375em; line-height: 1.45; font-style: italic; }
.quoteblock .attribution br, .verseblock .attribution br { display: none; }
.quoteblock .attribution cite, .verseblock .attribution cite { display: block; letter-spacing: -0.025em; color: rgba(0, 0, 0, 0.6); }

.quoteblock.abstract { margin: 0 0 1.25em 0; display: block; }
.quoteblock.abstract blockquote, .quoteblock.abstract blockquote p { text-align: left; word-spacing: 0; }
.quoteblock.abstract blockquote:before, .quoteblock.abstract blockquote p:first-of-type:before { display: none; }

table.tableblock { max-width: 100%; border-collapse: separate; }
table.tableblock td > .paragraph:last-child p > p:last-child, table.tableblock th > p:last-child, table.tableblock td > p:last-child { margin-bottom: 0; }

table.tableblock, th.tableblock, td.tableblock { border: 0 solid #dedede; }

table.grid-all th.tableblock, table.grid-all td.tableblock { border-width: 0 1px 1px 0; }

table.grid-all tfoot > tr > th.tableblock, table.grid-all tfoot > tr > td.tableblock { border-width: 1px 1px 0 0; }

table.grid-cols th.tableblock, table.grid-cols td.tableblock { border-width: 0 1px 0 0; }

table.grid-all * > tr > .tableblock:last-child, table.grid-cols * > tr > .tableblock:last-child { border-right-width: 0; }

table.grid-rows th.tableblock, table.grid-rows td.tableblock { border-width: 0 0 1px 0; }

table.grid-all tbody > tr:last-child > th.tableblock, table.grid-all tbody > tr:last-child > td.tableblock, table.grid-all thead:last-child > tr > th.tableblock, table.grid-rows tbody > tr:last-child > th.tableblock, table.grid-rows tbody > tr:last-child > td.tableblock, table.grid-rows thead:last-child > tr > th.tableblock { border-bottom-width: 0; }

table.grid-rows tfoot > tr > th.tableblock, table.grid-rows tfoot > tr > td.tableblock { border-width: 1px 0 0 0; }

table.frame-all { border-width: 1px; }

table.frame-sides { border-width: 0 1px; }

table.frame-topbot { border-width: 1px 0; }

th.halign-left, td.halign-left { text-align: left; }

th.halign-right, td.halign-right { text-align: right; }

th.halign-center, td.halign-center { text-align: center; }

th.valign-top, td.valign-top { vertical-align: top; }

th.valign-bottom, td.valign-bottom { vertical-align: bottom; }

th.valign-middle, td.valign-middle { vertical-align: middle; }

table thead th, table tfoot th { font-weight: bold; }

tbody tr th { display: table-cell; line-height: 1.6; background: #f7f8f7; }

tbody tr th, tbody tr th p, tfoot tr th, tfoot tr th p { color: rgba(0, 0, 0, 0.8); font-weight: bold; }

p.tableblock > code:only-child { background: none; padding: 0; }

p.tableblock { font-size: 1em; }

td > div.verse { white-space: pre; }

ol { margin-left: 1.75em; }

ul li ol { margin-left: 1.5em; }

dl dd { margin-left: 1.125em; }

dl dd:last-child, dl dd:last-child > :last-child { margin-bottom: 0; }

ol > li p, ul > li p, ul dd, ol dd, .olist .olist, .ulist .ulist, .ulist .olist, .olist .ulist { margin-bottom: 0.625em; }

ul.unstyled, ol.unnumbered, ul.checklist, ul.none { list-style-type: none; }

ul.unstyled, ol.unnumbered, ul.checklist { margin-left: 0.625em; }

ul.checklist li > p:first-child > .fa-square-o:first-child, ul.checklist li > p:first-child > .fa-check-square-o:first-child { width: 1em; font-size: 0.85em; }

ul.checklist li > p:first-child > input[type="checkbox"]:first-child { width: 1em; position: relative; top: 1px; }

ul.inline { margin: 0 auto 0.625em auto; margin-left: -1.375em; margin-right: 0; padding: 0; list-style: none; overflow: hidden; }
ul.inline > li { list-style: none; float: left; margin-left: 1.375em; display: block; }
ul.inline > li > * { display: block; }

.unstyled dl dt { font-weight: normal; font-style: normal; }

ol.arabic { list-style-type: decimal; }

ol.decimal { list-style-type: decimal-leading-zero; }

ol.loweralpha { list-style-type: lower-alpha; }

ol.upperalpha { list-style-type: upper-alpha; }

ol.lowerroman { list-style-type: lower-roman; }

ol.upperroman { list-style-type: upper-roman; }

ol.lowergreek { list-style-type: lower-greek; }

.hdlist > table, .colist > table { border: 0; background: none; }
.hdlist > table > tbody > tr, .colist > table > tbody > tr { background: none; }

td.hdlist1, td.hdlist2 { vertical-align: top; padding: 0 0.625em; }

td.hdlist1 { font-weight: bold; padding-bottom: 1.25em; }

.literalblock + .colist, .listingblock + .colist { margin-top: -0.5em; }

.colist > table tr > td:first-of-type { padding: 0 0.75em; line-height: 1; }
.colist > table tr > td:last-of-type { padding: 0.25em 0; }

.thumb, .th { line-height: 0; display: inline-block; border: solid 4px white; -webkit-box-shadow: 0 0 0 1px #dddddd; box-shadow: 0 0 0 1px #dddddd; }

.imageblock.left, .imageblock[style*="float: left"] { margin: 0.25em 0.625em 1.25em 0; }
.imageblock.right, .imageblock[style*="float: right"] { margin: 0.25em 0 1.25em 0.625em; }
.imageblock > .title { margin-bottom: 0; }
.imageblock.thumb, .imageblock.th { border-width: 6px; }
.imageblock.thumb > .title, .imageblock.th > .title { padding: 0 0.125em; }

.image.left, .image.right { margin-top: 0.25em; margin-bottom: 0.25em; display: inline-block; line-height: 0; }
.image.left { margin-right: 0.625em; }
.image.right { margin-left: 0.625em; }

a.image { text-decoration: none; display: inline-block; }
a.image object { pointer-events: none; }

sup.footnote, sup.footnoteref { font-size: 0.875em; position: static; vertical-align: super; }
sup.footnote a, sup.footnoteref a { text-decoration: none; }
sup.footnote a:active, sup.footnoteref a:active { text-decoration: underline; }

#footnotes { padding-top: 0.75em; padding-bottom: 0.75em; margin-bottom: 0.625em; }
#footnotes hr { width: 20%; min-width: 6.25em; margin: -0.25em 0 0.75em 0; border-width: 1px 0 0 0; }
#footnotes .footnote { padding: 0 0.375em 0 0.225em; line-height: 1.3334; font-size: 0.875em; margin-left: 1.2em; text-indent: -1.05em; margin-bottom: 0.2em; }
#footnotes .footnote a:first-of-type { font-weight: bold; text-decoration: none; }
#footnotes .footnote:last-of-type { margin-bottom: 0; }

#content #footnotes { margin-top: -0.625em; margin-bottom: 0; padding: 0.75em 0; }

.gist .file-data > table { border: 0; background: #fff; width: 100%; margin-bottom: 0; }
.gist .file-data > table td.line-data { width: 99%; }

div.unbreakable { page-break-inside: avoid; }

.big { font-size: larger; }

.small { font-size: smaller; }

.underline { text-decoration: underline; }

.overline { text-decoration: overline; }

.line-through { text-decoration: line-through; }

.aqua { color: #00bfbf; }

.aqua-background { background-color: #00fafa; }

.black { color: black; }

.black-background { background-color: black; }

.blue { color: #0000bf; }

.blue-background { background-color: #0000fa; }

.fuchsia { color: #bf00bf; }

.fuchsia-background { background-color: #fa00fa; }

.gray { color: #606060; }

.gray-background { background-color: #7d7d7d; }

.green { color: #006000; }

.green-background { background-color: #007d00; }

.lime { color: #00bf00; }

.lime-background { background-color: #00fa00; }

.maroon { color: #600000; }

.maroon-background { background-color: #7d0000; }

.navy { color: #000060; }

.navy-background { background-color: #00007d; }

.olive { color: #606000; }

.olive-background { background-color: #7d7d00; }

.purple { color: #600060; }

.purple-background { background-color: #7d007d; }

.red { color: #bf0000; }

.red-background { background-color: #fa0000; }

.silver { color: #909090; }

.silver-background { background-color: #bcbcbc; }

.teal { color: #006060; }

.teal-background { background-color: #007d7d; }

.white { color: #bfbfbf; }

.white-background { background-color: #fafafa; }

.yellow { color: #bfbf00; }

.yellow-background { background-color: #fafa00; }

span.icon > .fa { cursor: default; }

.admonitionblock td.icon [class^="fa icon-"] { font-size: 2.5em; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); cursor: default; }
.admonitionblock td.icon .icon-note:before { content: "\f05a"; color: #19407c; }
.admonitionblock td.icon .icon-tip:before { content: "\f0eb"; text-shadow: 1px 1px 2px rgba(155, 155, 0, 0.8); color: #111; }
.admonitionblock td.icon .icon-warning:before { content: "\f071"; color: #bf6900; }
.admonitionblock td.icon .icon-caution:before { content: "\f06d"; color: #bf3400; }
.admonitionblock td.icon .icon-important:before { content: "\f06a"; color: #bf0000; }

.conum[data-value] { display: inline-block; color: #fff !important; background-color: rgba(0, 0, 0, 0.8); -webkit-border-radius: 100px; border-radius: 100px; text-align: center; font-size: 0.75em; width: 1.67em; height: 1.67em; line-height: 1.67em; font-family: "Open Sans", "DejaVu Sans", sans-serif; font-style: normal; font-weight: bold; }
.conum[data-value] * { color: #fff !important; }
.conum[data-value] + b { display: none; }
.conum[data-value]:after { content: attr(data-value); }
pre .conum[data-value] { position: relative; top: -0.125em; }

b.conum * { color: inherit !important; }

.conum:not([data-value]):empty { display: none; }

dt, th.tableblock, td.content, div.footnote { text-rendering: optimizeLegibility; }

h1, h2, p, td.content, span.alt { letter-spacing: -0.01em; }

p strong, td.content strong, div.footnote strong { letter-spacing: -0.005em; }

p, blockquote, dt, td.content, span.alt { font-size: 1.0625rem; }

p { margin-bottom: 1.25rem; }

.sidebarblock p, .sidebarblock dt, .sidebarblock td.content, p.tableblock { font-size: 1em; }

.exampleblock > .content { background-color: #fffef7; border-color: #e0e0dc; -webkit-box-shadow: 0 1px 4px #e0e0dc; box-shadow: 0 1px 4px #e0e0dc; }

.print-only { display: none !important; }

@media print { @page { margin: 1.25cm 0.75cm; }
  * { -webkit-box-shadow: none !important; box-shadow: none !important; text-shadow: none !important; }
  a { color: inherit !important; text-decoration: underline !important; }
  a.bare, a[href^="#"], a[href^="mailto:"] { text-decoration: none !important; }
  a[href^="http:"]:not(.bare):after, a[href^="https:"]:not(.bare):after { content: "(" attr(href) ")"; display: inline-block; font-size: 0.875em; padding-left: 0.25em; }
  abbr[title]:after { content: " (" attr(title) ")"; }
  pre, blockquote, tr, img, object, svg { page-break-inside: avoid; }
  thead { display: table-header-group; }
  svg { max-width: 100%; }
  p, blockquote, dt, td.content { font-size: 1em; orphans: 3; widows: 3; }
  h2, h3, #toctitle, .sidebarblock > .content > .title, #toctitle, .sidebarblock > .content > .title { page-break-after: avoid; }
  #toc, .sidebarblock, .exampleblock > .content { background: none !important; }
  #toc { border-bottom: 1px solid #ddddd8 !important; padding-bottom: 0 !important; }
  .sect1 { padding-bottom: 0 !important; }
  .sect1 + .sect1 { border: 0 !important; }
  #header > h1:first-child { margin-top: 1.25rem; }
  body.book #header { text-align: center; }
  body.book #header > h1:first-child { border: 0 !important; margin: 2.5em 0 1em 0; }
  body.book #header .details { border: 0 !important; display: block; padding: 0 !important; }
  body.book #header .details span:first-child { margin-left: 0 !important; }
  body.book #header .details br { display: block; }
  body.book #header .details br + span:before { content: none !important; }
  body.book #toc { border: 0 !important; text-align: left !important; padding: 0 !important; margin: 0 !important; }
  body.book #toc, body.book #preamble, body.book h1.sect0, body.book .sect1 > h2 { page-break-before: always; }
  .listingblock code[data-lang]:before { display: block; }
  #footer { background: none !important; padding: 0 0.9375em; }
  #footer-text { color: rgba(0, 0, 0, 0.6) !important; font-size: 0.9em; }
  .hide-on-print { display: none !important; }
  .print-only { display: block !important; }
  .hide-for-print { display: none !important; }
  .show-for-print { display: inherit !important; } }

</style>
<link rel="stylesheet" href="css/font-awesome.css">
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>高可用负载均衡集群实践简明教程: High-Availability Loadbalancing Clusters Practice Guide for Beginners</h1>
<div class="details">
<span id="author" class="author">Fifi Lyu</span><br>
<span id="email" class="email"><a href="mailto:fifilyu@gmail.com">fifilyu@gmail.com</a></span><br>
<span id="revnumber">version 1.0.28,</span>
<span id="revdate">2016-10-09</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">目录</div>
<ul class="sectlevel0">
<li><a href="#_高可用负载均衡集群实践简明教程">高可用负载均衡集群实践简明教程</a>
<ul class="sectlevel1">
<li><a href="#_前言">1. 前言</a></li>
<li><a href="#_本书的读者">2. 本书的读者</a></li>
<li><a href="#_起步">3. 起步</a>
<ul class="sectlevel2">
<li><a href="#_centos">3.1. CentOS</a></li>
<li><a href="#_iptables">3.2. iptables</a></li>
<li><a href="#_linux_virtual_server">3.3. Linux Virtual Server</a></li>
<li><a href="#_keepalived">3.4. Keepalived</a></li>
<li><a href="#_mysql">3.5. MySQL</a></li>
<li><a href="#_network_file_system">3.6. Network File System</a></li>
<li><a href="#_nginx">3.7. Nginx</a></li>
<li><a href="#_rsync">3.8. Rsync</a></li>
</ul>
</li>
<li><a href="#_网络拓扑">4. 网络拓扑</a>
<ul class="sectlevel2">
<li><a href="#_总览">4.1. 总览</a></li>
<li><a href="#_web负载均衡与高可用_lvs_keepalived">4.2. Web负载均衡与高可用(LVS+Keepalived)</a></li>
<li><a href="#_web文件存储">4.3. Web文件存储</a></li>
<li><a href="#_db高可用_lvs_keepalived_无负载均衡">4.4. DB高可用(LVS+Keepalived，无负载均衡)</a></li>
<li><a href="#_db主主复制">4.5. DB主主复制</a></li>
<li><a href="#_备份">4.6. 备份</a></li>
</ul>
</li>
<li><a href="#_服务器与规划">5. 服务器与规划</a>
<ul class="sectlevel2">
<li><a href="#_服务器及其配件选购">5.1. 服务器及其配件选购</a></li>
<li><a href="#_网卡连接与网卡_ip映射">5.2. 网卡连接与网卡-IP映射</a></li>
<li><a href="#_ip地址表">5.3. IP地址表</a></li>
<li><a href="#_分区规划">5.4. 分区规划</a></li>
</ul>
</li>
<li><a href="#_安装设置centos6">6. 安装设置CentOS6</a>
<ul class="sectlevel2">
<li><a href="#_安装centos6">6.1. 安装CentOS6</a></li>
<li><a href="#_配置公有网络">6.2. 配置公有网络</a></li>
<li><a href="#_配置基于交换机的内网">6.3. 配置基于交换机的内网</a></li>
<li><a href="#_配置基于千兆网线的内网">6.4. 配置基于千兆网线的内网</a></li>
</ul>
</li>
<li><a href="#_nginx服务">7. Nginx服务</a>
<ul class="sectlevel2">
<li><a href="#_获取_2">7.1. 获取</a></li>
<li><a href="#_安装_2">7.2. 安装</a></li>
<li><a href="#_配置">7.3. 配置</a></li>
<li><a href="#_测试">7.4. 测试</a></li>
</ul>
</li>
<li><a href="#_mysql服务">8. MySQL服务</a>
<ul class="sectlevel2">
<li><a href="#_安装_3">8.1. 安装</a></li>
<li><a href="#_配置_2">8.2. 配置</a></li>
<li><a href="#_测试_2">8.3. 测试</a></li>
<li><a href="#_常见的复制模式">8.4. 常见的复制模式</a></li>
<li><a href="#_mysql配置文件">8.5. MySQL配置文件</a></li>
<li><a href="#_主_主复制">8.6. 主-主复制</a></li>
</ul>
</li>
<li><a href="#_lvs与keepalived服务">9. LVS与Keepalived服务</a>
<ul class="sectlevel2">
<li><a href="#_安装_4">9.1. 安装</a></li>
<li><a href="#_lvs工作模式与负载调度算法">9.2. LVS工作模式与负载调度算法</a></li>
<li><a href="#_lvs体验">9.3. LVS体验</a></li>
<li><a href="#_keepalived配置文件">9.4. Keepalived配置文件</a></li>
<li><a href="#_keepalived环境配置">9.5. Keepalived环境配置</a></li>
<li><a href="#_测试_5">9.6. 测试</a></li>
</ul>
</li>
<li><a href="#_nfs文件存储">10. NFS文件存储</a>
<ul class="sectlevel2">
<li><a href="#_安装_5">10.1. 安装</a></li>
<li><a href="#_文档">10.2. 文档</a></li>
<li><a href="#_配置_3">10.3. 配置</a></li>
<li><a href="#_测试_6">10.4. 测试</a></li>
</ul>
</li>
<li><a href="#_备份_2">11. 备份</a>
<ul class="sectlevel2">
<li><a href="#_常见的备份方式">11.1. 常见的备份方式</a></li>
<li><a href="#_备份策略">11.2. 备份策略</a></li>
<li><a href="#_设置备份">11.3. 设置备份</a></li>
<li><a href="#_使用备份">11.4. 使用备份</a></li>
</ul>
</li>
<li><a href="#_防火墙">12. 防火墙</a>
<ul class="sectlevel2">
<li><a href="#_选择_3">12.1. 选择</a></li>
<li><a href="#_设置">12.2. 设置</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<h1 id="_高可用负载均衡集群实践简明教程" class="sect0">高可用负载均衡集群实践简明教程</h1>
<div class="sect1">
<h2 id="_前言">1. 前言</h2>
<div class="sectionbody">
<div class="paragraph">
<p>灵活多样、开源、兼容性以及免费等特性成就了Linux。自然也无可避免存在各种碎片化问题。比如，Linux发行版过多，多个工具能解决同样的问题，知识体系过多对新手不太友好。一个常见的例子就是： Android 。</p>
</div>
<div class="paragraph">
<p>当基于Linux搭建集群时，理所当然的会面临最严重的问题：知识体系过多导致的碎片化。这么多选择，我该怎么办？选什么好呢？怎么搭建？诚然，看相关的博客、文章、图书以及文档是好的选择。但是，大多数时候需要的东西都是零散存在的。</p>
</div>
<div class="paragraph">
<p>所以，提供一个容易搭建、经过实践、可用并且成体系的集群解决方案是编写本书的目的。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_本书的读者">2. 本书的读者</h2>
<div class="sectionbody">
<div class="paragraph">
<p>本书可以作为搭建Web服务集群的一本入门指南或教程。它主要是为新手而设计,不过对于有经验的运维(System Administrator，简称SA)来说,它同样有用。</p>
</div>
<div class="paragraph">
<p>本书假设读者具有初步的 Linux 使用经验。了解 Linux 的基本工作原理，熟悉常用 Shell 命令。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_起步">3. 起步</h2>
<div class="sectionbody">
<div class="paragraph">
<p>我们从介绍Web集群相关的一些背景知识开始。
通过本章的学习，您应该了解各个部分在集群中发挥的作用。</p>
</div>
<div class="sect2">
<h3 id="_centos">3.1. CentOS</h3>
<div class="paragraph">
<p>集群中的作用：<strong><span class="red">操作系统</span></strong></p>
</div>
<div class="imageblock">
<div class="content">
<img src="image/centos_logo.jpg" alt="CentOS">
</div>
<div class="title">Figure 1: CentOS</div>
</div>
<div class="imageblock">
<div class="content">
<img src="image/centos7_desktop.jpg" alt="CentOS 7 桌面">
</div>
<div class="title">Figure 2: CentOS 7 桌面</div>
</div>
<div class="paragraph">
<p><a href="https://www.centos.org">CentOS</a> 是一个由社区支持的发行版本，它是由Red Hat公开的Red Hat Enterprise Linux（RHEL）源代码所衍
生出来的。因此，CentOS Linux以兼容 RHEL的功能为目标。CentOS计划对组件的修改主要是去除上游提供者的商标及美工图。CentOS是
免费的及可自由派发的。每个CentOS版本均获得长达十年的维护（通过安全更新 —— 支持期的长短取决于Red Hat发行的源代码的更改）。
新版本的CentOS大约每两年发行一次，而每个版本的CentOS更会定期（大概每六个月）更新一次，以便支持新的硬件。这最终构建了一个
安全的、低维护的、稳定的、高预测性的、高重复性的Linux环境。</p>
</div>
<div class="sect3">
<h4 id="_版本">3.1.1. 版本</h4>
<div class="dlist">
<dl>
<dt class="hdlist1">CentOS 7</dt>
<dd>
<p>最新版本，相对于其它版本变动较大，目前使用较少。估计2016年到2017年会成为大多数新服务器的首选</p>
</dd>
<dt class="hdlist1">CentOS 6</dt>
<dd>
<p>较新并且成熟的版本，目前大多数新服务器使用的版本。本书也将使用CentOS6做演示</p>
</dd>
<dt class="hdlist1">CentOS 5</dt>
<dd>
<p>老旧维护版本，仅仅会bugfix。不会增加任何新特性或者功能</p>
</dd>
</dl>
</div>
<div class="sect4">
<h5 id="_选择">选择</h5>
<div class="paragraph">
<p><strong><span class="red">在整个Linux生态链中，有一些共识</span></strong>。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">开发者</dt>
<dd>
<p>维护一个稳定版本、开发一个新版本</p>
</dd>
<dt class="hdlist1">使用者</dt>
<dd>
<p>老旧服务器保持所有组件大版本不变，仅仅需要打补丁即可<br>
新服务器使用当前较新并且稳定的版本，会刻意避免使用最新的版本</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>最新版本对上线的生产服务器来说，相对不够稳定，服务器开发或维护人员对新版本的认识和使用经验还不足。通俗来讲，新版本是一个
“填坑”的过程。当使用的数量足够大并且时间足够长新版会暴露一些问题，从而得到修复。所以，对我们来说，7.0时只是一个开始。
我们会大批量使用在生产服务器时应该是7.1+或7.2+ 。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
选择版本的经验，适用于任何操作系统、软件或工具。
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_iptables">3.2. iptables</h3>
<div class="paragraph">
<p>集群中的作用：<strong><span class="red">防火墙</span></strong></p>
</div>
<div class="paragraph">
<p><a href="http://www.netfilter.org/projects/iptables">iptables</a> 是一个用户空间命令行程序，用以配置Linux 2.4及其以上版本内核包过滤规则集，类似于Windows系统的防火墙。</p>
</div>
</div>
<div class="sect2">
<h3 id="_linux_virtual_server">3.3. Linux Virtual Server</h3>
<div class="paragraph">
<p>集群中的作用：<strong><span class="red">负载均衡和高可用</span></strong></p>
</div>
<div class="imageblock">
<div class="content">
<img src="image/lvs_logo.jpg" alt="Linux Virtual Server">
</div>
</div>
<div class="paragraph">
<p><a href="http://www.linuxvirtualserver.org">Linux Virtual Server (LVS)</a> 是一个建立在多个Real Server集群之上的高度可扩展且高可用服务器，使负载均衡运行于Linux系统之上。
服务器集群的结构是完全向最终用户透明的，对用户来说就像是一个独立的高性能虚拟服务器。</p>
</div>
<div class="paragraph">
<p>工作原理分别如下：</p>
</div>
<div class="imageblock">
<div class="content">
<img src="image/lvs.jpg" alt="LVS 工作原理">
</div>
</div>
<div class="paragraph">
<p>由于LVS的成功，从Linux 2.4内核开始，LVS已经被合并到了内核代码中。</p>
</div>
<div class="paragraph">
<p>本项目在1998年5月由章文嵩博士创建。此后一直作为Linux内核开发者。 目前，章文嵩博士任阿里集团副总裁、高级研究员。</p>
</div>
<div class="paragraph">
<p>更加详细的介绍，请访问 <a href="http://www.linuxvirtualserver.org/zh" class="bare">http://www.linuxvirtualserver.org/zh</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_keepalived">3.4. Keepalived</h3>
<div class="paragraph">
<p>集群中的作用：<strong><span class="red">负载均衡和高可用</span></strong></p>
</div>
<div class="paragraph">
<p><a href="http://www.keepalived.org">Keepalived</a> 是一个用C编写的路由软件。项目的主要目标是基于Linux系统提供简单稳定的负载均衡和高可用性基础设施。负载均衡框架依赖于鼎鼎大名的Linux虚拟服务器 (IPVS)内核模块提供Layer4负载均衡。Keepalived实现了一套校验器，能够根据健康状态自动管理维护负载均衡服务协议。另一方面，高可用性依靠VRRP协议实现。</p>
</div>
<div class="paragraph">
<p>工作原理分别如下：</p>
</div>
<div class="imageblock">
<div class="content">
<img src="image/keepalived.jpg" alt="Keepalived 工作原理">
</div>
</div>
<div class="paragraph">
<p>Keepalived根据配置文件设置负载均衡主服务器和从服务器，分别在主和从上增加Real Server到本机的LVS中。</p>
</div>
<div class="paragraph">
<p>主和从服务器：
每台主从服务器通过VRRP协议相互检测对方是否工作正常，如不正常，会做主和从之间的角色切换。</p>
</div>
<div class="paragraph">
<p>Real Server：
一般通过端口或HTTP URL返回值检测Real Server是否工作正常，如不正常，则从LVS规则中剔除。</p>
</div>
</div>
<div class="sect2">
<h3 id="_mysql">3.5. MySQL</h3>
<div class="paragraph">
<p>集群中的作用：<strong><span class="red">数据库</span></strong></p>
</div>
<div class="imageblock">
<div class="content">
<img src="image/mysql_logo.jpg" alt="MySQL">
</div>
</div>
<div class="paragraph">
<p><a href="http://www.mysql.com">MySQL</a> 是一个关系型数据库管理系统，由瑞典MySQL AB公司开发，目前属于Oracle公司。体积小、使用简单、容
易维护、高性能、成熟稳定以及开放源码等特点使MySQL成为大多数人的首选。特别是Linux+Apache/Nginx+MySQL+PHP(LAMP/LNMP)这样的
组合，突出了高性能和快速开发的优势，使MySQL应用更加广泛。</p>
</div>
<div class="paragraph">
<p>凡是需要数据库的地方，都可以看到MySQL的身影。比如，阿里(淘宝、天猫)、亚马逊、YouTube、Facebook、Google等等。其中，阿里、
亚马逊、Facebook、Google等企业甚至修改MySQL代码以支撑自身的应用需求。</p>
</div>
<div class="paragraph">
<p>MySQL软件采用了双授权政策，它分为社区版和商业版。</p>
</div>
</div>
<div class="sect2">
<h3 id="_network_file_system">3.6. Network File System</h3>
<div class="paragraph">
<p>集群中的作用：<strong><span class="red">文件存储</span></strong></p>
</div>
<div class="paragraph">
<p><a href="https://tools.ietf.org/html/rfc1813">Network File System (NFS)</a> 是一种分布式文件系统协议，最初由Sun Microsystems 公司开发，并于1984年发布。其功能旨在允许客户端主机可以像访问本地存储一样通过网络访问服务器端文件。</p>
</div>
<div class="paragraph">
<p>NFS在RFC中是一个开放、标准的协议，任何人或组织都可以依据标准实现它。</p>
</div>
</div>
<div class="sect2">
<h3 id="_nginx">3.7. Nginx</h3>
<div class="paragraph">
<p>集群中的作用：<strong><span class="red">Web 服务器</span></strong></p>
</div>
<div class="imageblock">
<div class="content">
<img src="image/nginx_logo.jpg" alt="CentOS" width="200" height="48">
</div>
</div>
<div class="paragraph">
<p><a href="http://nginx.org">Nginx</a> 是一个HTTP、反向代理、邮件代理、TCP代理服务器。很长一段时间里，许多大访问量的俄罗斯网站都运行于Nginx之上。2015年7月，Nginx服务或代理了最繁忙站点中的22.27%。</p>
</div>
<div class="paragraph">
<p>Nginx最初是为俄罗斯访问量第二的Rambler.ru开发的。意识到Ningx对整个互联网的作用，最后Nignx被开源出来。随后Apache的垄断地位被颠覆。
起初，没人想用 C 重写一个“Apache”，写出来能比Apache好吗？</p>
</div>
</div>
<div class="sect2">
<h3 id="_rsync">3.8. Rsync</h3>
<div class="paragraph">
<p>集群中的作用：<strong><span class="red">文件同步与备份</span></strong></p>
</div>
<div class="paragraph">
<p><a href="https://rsync.samba.org">Rsync</a> 是一个用于文件快速增量传输的开源工具。在行业内，常用来做文件的增量同步或增量备份。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_网络拓扑">4. 网络拓扑</h2>
<div class="sectionbody">
<div class="paragraph">
<p>在我们动手搭建集群之前，非常有必要熟悉整体结构。</p>
</div>
<div class="sect2">
<h3 id="_总览">4.1. 总览</h3>
<div class="imageblock">
<div class="content">
<img src="image/1-总览.jpg" alt="总览" width="600" height="800">
</div>
<div class="title">Figure 1: 总览</div>
</div>
</div>
<div class="sect2">
<h3 id="_web负载均衡与高可用_lvs_keepalived">4.2. Web负载均衡与高可用(LVS+Keepalived)</h3>
<div class="imageblock">
<div class="content">
<img src="image/2-Web负载均衡与高可用.jpg" alt="Web负载均衡与高可用(LVS+Keepalived)" width="600">
</div>
<div class="title">Figure 2: Web负载均衡与高可用(LVS+Keepalived)</div>
</div>
</div>
<div class="sect2">
<h3 id="_web文件存储">4.3. Web文件存储</h3>
<div class="imageblock">
<div class="content">
<img src="image/3-Web文件存储.jpg" alt="Web文件存储" width="600">
</div>
<div class="title">Figure 3: Web文件存储</div>
</div>
</div>
<div class="sect2">
<h3 id="_db高可用_lvs_keepalived_无负载均衡">4.4. DB高可用(LVS+Keepalived，无负载均衡)</h3>
<div class="imageblock">
<div class="content">
<img src="image/4-DB高可用.jpg" alt="DB高可用(LVS+Keepalived，无负载均衡)" width="600">
</div>
<div class="title">Figure 4: DB高可用(LVS+Keepalived，无负载均衡)</div>
</div>
</div>
<div class="sect2">
<h3 id="_db主主复制">4.5. DB主主复制</h3>
<div class="imageblock">
<div class="content">
<img src="image/5-DB主主复制.jpg" alt="DB主主复制" width="600">
</div>
<div class="title">Figure 5: DB主主复制</div>
</div>
</div>
<div class="sect2">
<h3 id="_备份">4.6. 备份</h3>
<div class="imageblock">
<div class="content">
<img src="image/6-备份.jpg" alt="备份" width="600">
</div>
<div class="title">Figure 6: 备份</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_服务器与规划">5. 服务器与规划</h2>
<div class="sectionbody">
<div class="paragraph">
<p>没有足够的实践经验，难以选择集群适用的硬件，也难以合理的规划系统分区等，并应用到集群。本书根据内容需求，提供一个硬件选择与系统规划方案。</p>
</div>
<div class="sect2">
<h3 id="_服务器及其配件选购">5.1. 服务器及其配件选购</h3>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 1. 服务器</caption>
<colgroup>
<col style="width: 12.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 12.5%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">主机名</th>
<th class="tableblock halign-left valign-top">网口数量</th>
<th class="tableblock halign-left valign-top">CPU</th>
<th class="tableblock halign-left valign-top">硬盘</th>
<th class="tableblock halign-left valign-top">内存</th>
<th class="tableblock halign-left valign-top">用途</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Server1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">推荐2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">至少两核</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2x任意</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">至少2G</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">负载均衡</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Server2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">至少2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">至少两核</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">推荐2xSAS 1T或以上</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">至少2G</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">负载均衡&amp;备份</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Server3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">推荐4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">至少两核</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">推荐2xSAS 1T或以上</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">至少2G</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">文件存储</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Server4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">至少2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">推荐四核</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">推荐2xSAS 500G或以上</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">推荐16G或以上</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">数据库服务</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Server5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">至少2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">推荐四核</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">推荐2xSAS 500G或以上</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">推荐16G或以上</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">数据库服务</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Server6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">至少2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">至少两核</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">推荐2xSATA 500G或以上</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">推荐8G或以上</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Web服务</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Server7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">至少2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">至少两核</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">推荐2xSATA 500G或以上</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">推荐8G或以上</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Web服务</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 2. 配件</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">名称</th>
<th class="tableblock halign-left valign-top">数量(根)</th>
<th class="tableblock halign-left valign-top">备注</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">千兆网线</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">需要4根，备用1根</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
一定要购买质量好的千兆网线。<br>
<strong><span class="red">质量差的千兆网线，在使用过程当中会从1000M变成100M，导致性能相差10倍。</span></strong>
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>Server2和Server3尽量采用相同大小的硬盘。如果Server3硬盘故障，可以用Server2的硬盘直接替换，快速解决问题。</p>
</li>
<li>
<p>为提升数据库服务性能，一般采用CPU和内存换性能的方法。所以，Server4和Server5需要尽量多的CPU和内存。</p>
</li>
<li>
<p>文件存储和数据库服务都需要大量读写硬盘文件，需要更多的硬盘IO和更高的稳定性。推荐SAS硬盘，如果条件允许甚至可以选择SSD硬盘
或15000 RPM的SAS硬盘。当然，用SSD硬盘做缓存也是可以的，这个需要结合集群框架来实现。</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_网卡连接与网卡_ip映射">5.2. 网卡连接与网卡-IP映射</h3>
<div class="imageblock">
<div class="content">
<img src="image/2-网卡连接与网卡-IP映射.jpg" alt="网卡连接与网卡-IP映射" width="600">
</div>
<div class="title">Figure 2: 网卡连接与网卡-IP映射</div>
</div>
</div>
<div class="sect2">
<h3 id="_ip地址表">5.3. IP地址表</h3>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 3. IP地址表</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">类型</th>
<th class="tableblock halign-center valign-top">主机名</th>
<th class="tableblock halign-center valign-top">网络接口</th>
<th class="tableblock halign-center valign-top">IP 地址</th>
<th class="tableblock halign-center valign-top">网络类型</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="4"><p class="tableblock">Master LVS</p></td>
<td class="tableblock halign-center valign-middle" rowspan="4"><p class="tableblock">Server1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><span class="red">eth0</span></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><span class="red">192.168.1.70</span></strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong><span class="red">Public IP</span></strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><span class="black">eth0:lan</span></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><span class="black">10.10.10.70</span></strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong><span class="black">Private IP</span></strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">eth0:db</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10.10.10.100</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Virtual IP</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">eth0:web</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">192.168.1.200</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Virtual IP</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="5"><p class="tableblock">Backup LVS&amp;备份</p></td>
<td class="tableblock halign-center valign-middle" rowspan="5"><p class="tableblock">Server2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><span class="red">eth0</span></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><span class="red">192.168.1.80</span></strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong><span class="red">Public IP</span></strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><span class="black">eth0:lan</span></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><span class="black">10.10.10.80</span></strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong><span class="black">Private IP</span></strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">eth0:db</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10.10.10.100</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Virtual IP</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">eth0:web</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">192.168.1.200</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Virtual IP</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><span class="green">eth1</span></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><span class="green">12.12.12.80</span></strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong><span class="green">Private IP</span></strong></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="3"><p class="tableblock">Web文件存储</p></td>
<td class="tableblock halign-center valign-middle" rowspan="3"><p class="tableblock">Server3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><span class="red">eth0</span></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><span class="red">192.168.1.90</span></strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong><span class="red">Public IP</span></strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><span class="blue">eth1</span></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><span class="blue">11.11.11.90</span></strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong><span class="blue">Private IP</span></strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><span class="green">eth2</span></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><span class="green">12.12.12.90</span></strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong><span class="green">Private IP</span></strong></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="3"><p class="tableblock">MySQL1</p></td>
<td class="tableblock halign-center valign-middle" rowspan="3"><p class="tableblock">Server4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><span class="red">eth0</span></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><span class="red">192.168.1.101</span></strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong><span class="red">Public IP</span></strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><span class="black">eth0:lan</span></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><span class="black">10.10.10.101</span></strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong><span class="black">Private IP</span></strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><span class="purple">eth1</span></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><span class="purple">13.13.13.101</span></strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong><span class="purple">Private IP</span></strong></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="3"><p class="tableblock">MySQL2</p></td>
<td class="tableblock halign-center valign-middle" rowspan="3"><p class="tableblock">Server5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><span class="red">eth0</span></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><span class="red">192.168.1.102</span></strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong><span class="red">Public IP</span></strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><span class="black">eth0:lan</span></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><span class="black">10.10.10.102</span></strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong><span class="black">Private IP</span></strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><span class="purple">eth1</span></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><span class="purple">13.13.13.102</span></strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong><span class="purple">Private IP</span></strong></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="3"><p class="tableblock">Nginx1</p></td>
<td class="tableblock halign-center valign-middle" rowspan="3"><p class="tableblock">Server6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><span class="red">eth0</span></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><span class="red">192.168.1.201</span></strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong><span class="red">Public IP</span></strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><span class="black">eth0:lan</span></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><span class="black">10.10.10.201</span></strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong><span class="black">Private IP</span></strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><span class="blue">eth1</span></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><span class="blue">11.11.11.201</span></strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong><span class="blue">Private IP</span></strong></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle" rowspan="3"><p class="tableblock">Nginx2</p></td>
<td class="tableblock halign-center valign-middle" rowspan="3"><p class="tableblock">Server7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><span class="red">eth0</span></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><span class="red">192.168.1.202</span></strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong><span class="red">Public IP</span></strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><span class="black">eth0:lan</span></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><span class="black">10.10.10.202</span></strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong><span class="black">Private IP</span></strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><span class="blue">eth1</span></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><span class="blue">14.14.14.202</span></strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong><span class="blue">Private IP</span></strong></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_分区规划">5.4. 分区规划</h3>
<div class="paragraph">
<p>正常情况，安装完CentOS后，根分区使用1.5G左右。
为保证根分区在现在和未来都足够大，此处分配50G。</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 4. Server1/2/3/4/5/6/7</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">分区</th>
<th class="tableblock halign-left valign-top">大小</th>
<th class="tableblock halign-left valign-top">挂载点</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">/dev/sda1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">50G</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">/dev/sda2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">sda剩余可用空间</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/data2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">/dev/sdb1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">sdb全部可用空间</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/data</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>为方便使用，可以增加链接 <code>ln -s /data2 /data/data2</code>。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
本书没有为虚拟内存(SWAP)单独分区，打算使用单独的文件(/var/swap.file)作虚拟内存。
当然，为演示目的不设置任何虚拟内存也是可以的。只要保证内存没使用完即可。
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
/dev/sda2 和 /dev/sdb1 可以加入LVM卷组，并将所有空间划分到同一个逻辑卷，然后挂载到/data。
但是，为了维护性并没有使用LVM。因为，sda或sdb中任意一个硬盘出现故障时，无法保证数据完整。
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_安装设置centos6">6. 安装设置CentOS6</h2>
<div class="sectionbody">
<div class="paragraph">
<p>集群服务是网络服务的一个子集，在一切开始以前，需要先准备好网络。</p>
</div>
<div class="sect2">
<h3 id="_安装centos6">6.1. 安装CentOS6</h3>
<div class="sect3">
<h4 id="_获取">6.1.1. 获取</h4>
<div class="paragraph">
<p>访问 <a href="http://wiki.centos.org/Download" class="bare">http://wiki.centos.org/Download</a> 选择 “CentOS-6”&#8594;“x86_64”，选择最快的镜像下载“CentOS-6.7-x86_64-minimal.iso”。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
推荐安装迷你版本，这是最小化安装。占用最少的硬盘空间，安装最少的软件包。
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_安装">6.1.2. 安装</h4>
<div class="paragraph">
<p>限于篇幅，本书不涉及具体的安装过程。</p>
</div>
<div class="paragraph">
<p>详细的安装文档，请访问：
<a href="https://access.redhat.com/documentation/zh-CN/Red_Hat_Enterprise_Linux/6/html/Installation_Guide/index.html">Red Hat Enterprise Linux 6 Installation Guide</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_安装软件包">6.1.3. 安装软件包</h4>
<div class="paragraph">
<p>缓存软件包列表：<code>yum makecache</code></p>
</div>
<div class="paragraph">
<p>安装：<code>yum install -y curl rsync vim wget mysql</code></p>
</div>
</div>
<div class="sect3">
<h4 id="_设置系统">6.1.4. 设置系统</h4>
<div class="paragraph">
<p>禁用SELINUX，必须重启才能生效</p>
</div>
<div class="paragraph">
<p><code>echo SELINUX=disabled&gt;/etc/selinux/config</code></p>
</div>
<div class="paragraph">
<p><code>echo SELINUXTYPE=targeted&gt;&gt;/etc/selinux/config</code></p>
</div>
<div class="paragraph">
<p>清除iptables的默认规则</p>
</div>
<div class="paragraph">
<p><code>iptables -F</code></p>
</div>
<div class="paragraph">
<p><code>service  iptables save</code></p>
</div>
<div class="paragraph">
<p>ssh登录时，登录ip被会服务端反向解析为域名，导致ssh登录缓慢</p>
</div>
<div class="paragraph">
<p><code>sed -i "s/#UseDNS yes/UseDNS no/" /etc/ssh/sshd_config</code></p>
</div>
<div class="paragraph">
<p>ssh登录时，GSSAPIAuthentication认证会导致登录缓慢</p>
</div>
<div class="paragraph">
<p><code>sed -i "s/GSSAPIAuthentication yes/GSSAPIAuthentication no/" /etc/ssh/sshd_config</code></p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
对新手来说SELINUX和默认的iptables规则带来太多麻烦。搭建集群时，我们暂时禁用和关闭它们。
整个集群成功后，可以考虑启用它们。
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_配置公有网络">6.2. 配置公有网络</h3>
<div class="paragraph">
<p>配置对外提供服务的IP地址。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
严格意义上讲，<strong>192.168.0.0/16</strong> 属于私有网络，私有网络的IP无法直接连接互联网，需要公网IP转发。
本书为演示目的，广义上称 <strong>192.168.0.0/16</strong> 网络为公有网络（公网）， <strong>10.0.0.0/8</strong> 、 <strong>11.0.0.0/8</strong> 、 <strong>12.0.0.0/8</strong> 以及
 <strong>13.0.0.0/8</strong> 网络为私有网络（内网）。
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
本书假设网卡前缀为常用的eth。根据网卡类型的不同，CentOS会修改网卡前缀为em或eno等等。
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
内网不需要配置网关和DNS。
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>按照以下命令操作后，</p>
</div>
<div class="ulist">
<ul>
<li>
<p>记得重启网络服务 <code>service network restart</code></p>
</li>
<li>
<p>通过命令 <code>ip a</code> ，查看IP配置是否生效</p>
</li>
<li>
<p>通过命令 <code>cat /etc/resolv.conf</code> ，查看DNS配置是否生效。但是，本书推荐直接 <code>ping qq.com</code> 看看能否解析出IP地址</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>PS: 为什么用 <code>ping qq.com</code> 代替cat命令？因为打字少啊！</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
ifconfig命令已经过时，建议使用ip命令代替。
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_服务器_server1">6.2.1. 服务器 Server1</h4>
<div class="paragraph">
<p>IP地址：<strong><span class="red">192.168.1.70</span></strong></p>
</div>
<div class="listingblock">
<div class="title">网卡eth0</div>
<div class="content">
<pre>cat &lt;&lt; EOF &gt; /etc/sysconfig/network-scripts/ifcfg-eth0
DEVICE=eth0
BOOTPROTO=none
ONBOOT=yes
IPADDR=192.168.1.70
NETMASK=255.255.255.0
GATEWAY=192.168.1.1
DNS1=223.5.5.5
DNS2=223.6.6.6
EOF</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_服务器_server2">6.2.2. 服务器 Server2</h4>
<div class="paragraph">
<p>IP地址：<strong><span class="red">192.168.1.80</span></strong></p>
</div>
<div class="listingblock">
<div class="title">网卡eth0</div>
<div class="content">
<pre>cat &lt;&lt; EOF &gt; /etc/sysconfig/network-scripts/ifcfg-eth0
DEVICE=eth0
BOOTPROTO=none
ONBOOT=yes
IPADDR=192.168.1.80
NETMASK=255.255.255.0
GATEWAY=192.168.1.1
DNS1=223.5.5.5
DNS2=223.6.6.6
EOF</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_服务器_server3">6.2.3. 服务器 Server3</h4>
<div class="paragraph">
<p>IP地址：<strong><span class="red">192.168.1.90</span></strong></p>
</div>
<div class="listingblock">
<div class="title">网卡eth0</div>
<div class="content">
<pre>cat &lt;&lt; EOF &gt; /etc/sysconfig/network-scripts/ifcfg-eth0
DEVICE=eth0
BOOTPROTO=none
ONBOOT=yes
IPADDR=192.168.1.90
NETMASK=255.255.255.0
GATEWAY=192.168.1.1
DNS1=223.5.5.5
DNS2=223.6.6.6
EOF</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_服务器_server4">6.2.4. 服务器 Server4</h4>
<div class="paragraph">
<p>IP地址：<strong><span class="red">192.168.1.101</span></strong></p>
</div>
<div class="listingblock">
<div class="title">网卡eth0</div>
<div class="content">
<pre>cat &lt;&lt; EOF &gt; /etc/sysconfig/network-scripts/ifcfg-eth0
DEVICE=eth0
BOOTPROTO=none
ONBOOT=yes
IPADDR=192.168.1.101
NETMASK=255.255.255.0
GATEWAY=192.168.1.1
DNS1=223.5.5.5
DNS2=223.6.6.6
EOF</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_服务器_server5">6.2.5. 服务器 Server5</h4>
<div class="paragraph">
<p>IP地址：<strong><span class="red">192.168.1.102</span></strong></p>
</div>
<div class="listingblock">
<div class="title">网卡eth0</div>
<div class="content">
<pre>cat &lt;&lt; EOF &gt; /etc/sysconfig/network-scripts/ifcfg-eth0
DEVICE=eth0
BOOTPROTO=none
ONBOOT=yes
IPADDR=192.168.1.102
NETMASK=255.255.255.0
GATEWAY=192.168.1.1
DNS1=223.5.5.5
DNS2=223.6.6.6
EOF</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_服务器_server6">6.2.6. 服务器 Server6</h4>
<div class="paragraph">
<p>IP地址：<strong><span class="red">192.168.1.201</span></strong></p>
</div>
<div class="listingblock">
<div class="title">网卡eth0</div>
<div class="content">
<pre>cat &lt;&lt; EOF &gt; /etc/sysconfig/network-scripts/ifcfg-eth0
DEVICE=eth0
BOOTPROTO=none
ONBOOT=yes
IPADDR=192.168.1.201
NETMASK=255.255.255.0
GATEWAY=192.168.1.1
DNS1=223.5.5.5
DNS2=223.6.6.6
EOF</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_服务器_server7">6.2.7. 服务器 Server7</h4>
<div class="paragraph">
<p>IP地址：<strong><span class="red">192.168.1.202</span></strong></p>
</div>
<div class="listingblock">
<div class="title">网卡eth0</div>
<div class="content">
<pre>cat &lt;&lt; EOF &gt; /etc/sysconfig/network-scripts/ifcfg-eth0
DEVICE=eth0
BOOTPROTO=none
ONBOOT=yes
IPADDR=192.168.1.202
NETMASK=255.255.255.0
GATEWAY=192.168.1.1
DNS1=223.5.5.5
DNS2=223.6.6.6
EOF</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_配置基于交换机的内网">6.3. 配置基于交换机的内网</h3>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
内网不需要配置网关和DNS。
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>按照以下命令操作后，</p>
</div>
<div class="ulist">
<ul>
<li>
<p>记得重启网络服务 <code>service network restart</code></p>
</li>
<li>
<p>通过命令 <code>ip a</code> ，查看IP配置是否生效</p>
</li>
<li>
<p>通过命令 <code>cat /etc/resolv.conf</code> ，查看DNS配置是否生效。但是，本书推荐直接 <code>ping qq.com</code> 看看能否解析出IP地址</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>PS: 为什么用 <code>ping qq.com</code> 代替cat命令？因为打字少啊！</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
ifconfig命令已经过时，建议使用ip命令代替。
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_服务器server1">6.3.1. 服务器Server1</h4>
<div class="paragraph">
<p>IP地址：<strong><span class="red">10.10.10.70</span></strong></p>
</div>
<div class="listingblock">
<div class="title">网卡eth0:lan</div>
<div class="content">
<pre>cat &lt;&lt; EOF &gt; /etc/sysconfig/network-scripts/ifcfg-eth0:lan
DEVICE=eth0:lan
BOOTPROTO=none
ONBOOT=yes
IPADDR=10.10.10.70
NETMASK=255.255.255.0
EOF</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_服务器_server2_2">6.3.2. 服务器 Server2</h4>
<div class="paragraph">
<p>IP地址：<strong><span class="red">10.10.10.80</span></strong></p>
</div>
<div class="listingblock">
<div class="title">网卡eth0:lan</div>
<div class="content">
<pre>cat &lt;&lt; EOF &gt; /etc/sysconfig/network-scripts/ifcfg-eth0:lan
DEVICE=eth0:lan
BOOTPROTO=none
ONBOOT=yes
IPADDR=10.10.10.80
NETMASK=255.255.255.0
EOF</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_服务器_server3_2">6.3.3. 服务器 Server3</h4>
<div class="paragraph">
<p>IP地址：<strong><span class="red">10.10.10.90</span></strong></p>
</div>
<div class="listingblock">
<div class="title">网卡eth0:lan</div>
<div class="content">
<pre>cat &lt;&lt; EOF &gt; /etc/sysconfig/network-scripts/ifcfg-eth0:lan
DEVICE=eth0:lan
BOOTPROTO=none
ONBOOT=yes
IPADDR=10.10.10.90
NETMASK=255.255.255.0
EOF</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_服务器_server4_2">6.3.4. 服务器 Server4</h4>
<div class="paragraph">
<p>IP地址：<strong><span class="red">10.10.10.101</span></strong></p>
</div>
<div class="listingblock">
<div class="title">网卡eth0:lan</div>
<div class="content">
<pre>cat &lt;&lt; EOF &gt; /etc/sysconfig/network-scripts/ifcfg-eth0:lan
DEVICE=eth0:lan
BOOTPROTO=none
ONBOOT=yes
IPADDR=10.10.10.101
NETMASK=255.255.255.0
EOF</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_服务器_server5_2">6.3.5. 服务器 Server5</h4>
<div class="paragraph">
<p>IP地址：<strong><span class="red">10.10.10.102</span></strong></p>
</div>
<div class="listingblock">
<div class="title">网卡eth0:lan</div>
<div class="content">
<pre>cat &lt;&lt; EOF &gt; /etc/sysconfig/network-scripts/ifcfg-eth0:lan
DEVICE=eth0:lan
BOOTPROTO=none
ONBOOT=yes
IPADDR=10.10.10.102
NETMASK=255.255.255.0
EOF</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_服务器_server6_2">6.3.6. 服务器 Server6</h4>
<div class="paragraph">
<p>IP地址：<strong><span class="red">10.10.10.201</span></strong></p>
</div>
<div class="listingblock">
<div class="title">网卡eth0:lan</div>
<div class="content">
<pre>cat &lt;&lt; EOF &gt; /etc/sysconfig/network-scripts/ifcfg-eth0:lan
DEVICE=eth0:lan
BOOTPROTO=none
ONBOOT=yes
IPADDR=10.10.10.201
NETMASK=255.255.255.0
EOF</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_服务器_server7_2">6.3.7. 服务器 Server7</h4>
<div class="paragraph">
<p>IP地址：<strong><span class="red">10.10.10.202</span></strong></p>
</div>
<div class="listingblock">
<div class="title">网卡eth0:lan</div>
<div class="content">
<pre>cat &lt;&lt; EOF &gt; /etc/sysconfig/network-scripts/ifcfg-eth0:lan
DEVICE=eth0:lan
BOOTPROTO=none
ONBOOT=yes
IPADDR=10.10.10.202
NETMASK=255.255.255.0
EOF</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_配置基于千兆网线的内网">6.4. 配置基于千兆网线的内网</h3>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<strong><strong><span class="red">为什么又看到这个提示？因为&#8230;&#8203;&#8230;&#8203;重要的事情说三遍。</span></strong></strong>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
内网不需要配置网关和DNS。
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>按照以下命令操作后，</p>
</div>
<div class="ulist">
<ul>
<li>
<p>记得重启网络服务 <code>service network restart</code></p>
</li>
<li>
<p>通过命令 <code>ip a</code> ，查看IP配置是否生效</p>
</li>
<li>
<p>通过命令 <code>cat /etc/resolv.conf</code> ，查看DNS配置是否生效。但是，本书推荐直接 <code>ping qq.com</code> 看看能否解析出IP地址</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>PS: 为什么用 <code>ping qq.com</code> 代替cat命令？因为打字少啊！</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
ifconfig命令已经过时，建议使用ip命令代替。
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_配置nfs存储内网">6.4.1. 配置NFS存储内网</h4>
<div class="paragraph">
<p>Server3作为NFS服务端，Server2&amp;6&amp;7作为NFS客户端。Server2&amp;3、Server3&amp;6以及Server3&amp;7之间使用千兆网线直连，需要配置各自的内网。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Server2&amp;3</dt>
<dd>
<p>12.12.12.0/24</p>
</dd>
<dt class="hdlist1">Server3&amp;6</dt>
<dd>
<p>11.11.11.0/24</p>
</dd>
<dt class="hdlist1">Server3&amp;7</dt>
<dd>
<p>14.14.14.0/24</p>
</dd>
</dl>
</div>
<div class="sect4">
<h5 id="_服务器_server2_3">服务器 Server2</h5>
<div class="paragraph">
<p>IP地址：<strong><span class="red">12.12.12.80</span></strong></p>
</div>
<div class="listingblock">
<div class="title">网卡eth1</div>
<div class="content">
<pre>cat &lt;&lt; EOF &gt; /etc/sysconfig/network-scripts/ifcfg-eth1
DEVICE=eth1
BOOTPROTO=none
ONBOOT=yes
IPADDR=12.12.12.80
NETMASK=255.255.255.0
EOF</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_服务器_server3_3">服务器 Server3</h5>
<div class="paragraph">
<p>IP地址：</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong><span class="red">11.11.11.90</span></strong></p>
</li>
<li>
<p><strong><span class="red">12.12.12.90</span></strong></p>
</li>
<li>
<p><strong><span class="red">14.14.14.90</span></strong></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">网卡eth1</div>
<div class="content">
<pre>cat &lt;&lt; EOF &gt; /etc/sysconfig/network-scripts/ifcfg-eth1
DEVICE=eth1
BOOTPROTO=none
ONBOOT=yes
IPADDR=11.11.11.90
NETMASK=255.255.255.0
EOF</pre>
</div>
</div>
<div class="listingblock">
<div class="title">网卡eth2</div>
<div class="content">
<pre>cat &lt;&lt; EOF &gt; /etc/sysconfig/network-scripts/ifcfg-eth2
DEVICE=eth2
BOOTPROTO=none
ONBOOT=yes
IPADDR=12.12.12.90
NETMASK=255.255.255.0
EOF</pre>
</div>
</div>
<div class="listingblock">
<div class="title">网卡eth3</div>
<div class="content">
<pre>cat &lt;&lt; EOF &gt; /etc/sysconfig/network-scripts/ifcfg-eth3
DEVICE=eth3
BOOTPROTO=none
ONBOOT=yes
IPADDR=14.14.14.90
NETMASK=255.255.255.0
EOF</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_服务器_server6_3">服务器 Server6</h5>
<div class="paragraph">
<p>IP地址：<strong><span class="red">11.11.11.201</span></strong></p>
</div>
<div class="listingblock">
<div class="title">网卡eth1</div>
<div class="content">
<pre>cat &lt;&lt; EOF &gt; /etc/sysconfig/network-scripts/ifcfg-eth1
DEVICE=eth1
BOOTPROTO=none
ONBOOT=yes
IPADDR=11.11.11.201
NETMASK=255.255.255.0
EOF</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_服务器_server7_3">服务器 Server7</h5>
<div class="paragraph">
<p>IP地址：<strong><span class="red">14.14.14.202</span></strong></p>
</div>
<div class="listingblock">
<div class="title">网卡eth1</div>
<div class="content">
<pre>cat &lt;&lt; EOF &gt; /etc/sysconfig/network-scripts/ifcfg-eth1
DEVICE=eth1
BOOTPROTO=none
ONBOOT=yes
IPADDR=14.14.14.202
NETMASK=255.255.255.0
EOF</pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_配置mysql内网">6.4.2. 配置MySQL内网</h4>
<div class="paragraph">
<p>Server4/5 都是MySQL服务器，使用千兆网线直连在第二个网卡。</p>
</div>
<div class="sect4">
<h5 id="_服务器_server4_3">服务器 Server4</h5>
<div class="paragraph">
<p>IP地址：<strong><span class="red">13.13.13.101</span></strong></p>
</div>
<div class="listingblock">
<div class="title">网卡eth1</div>
<div class="content">
<pre>cat &lt;&lt; EOF &gt; /etc/sysconfig/network-scripts/ifcfg-eth1
DEVICE=eth1
BOOTPROTO=none
ONBOOT=yes
IPADDR=13.13.13.101
NETMASK=255.255.255.0
EOF</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_服务器_server5_3">服务器 Server5</h5>
<div class="paragraph">
<p>IP地址：<strong><span class="red">13.13.13.102</span></strong></p>
</div>
<div class="listingblock">
<div class="title">网卡eth1</div>
<div class="content">
<pre>cat &lt;&lt; EOF &gt; /etc/sysconfig/network-scripts/ifcfg-eth1
DEVICE=eth1
BOOTPROTO=none
ONBOOT=yes
IPADDR=13.13.13.102
NETMASK=255.255.255.0
EOF</pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_nginx服务">7. Nginx服务</h2>
<div class="sectionbody">
<div class="paragraph">
<p>在Server3上，仅仅安装Nginx，不需要配置、启动和测试。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
仅仅是为了使系统用户nginx存在。NFS服务器共享文件给Nginx服务器使用，而NFS共享的目录对系统用户nginx来说是可读写的。
需要保证这些服务器上都存在系统用户nginx。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>在Server6&amp;7上，分别安装Nginx并测试。</p>
</div>
<div class="sect2">
<h3 id="_获取_2">7.1. 获取</h3>
<div class="paragraph">
<p>访问 <a href="http://nginx.org/en/linux_packages.html#stable" class="bare">http://nginx.org/en/linux_packages.html#stable</a> 获取Nginx安装包。</p>
</div>
</div>
<div class="sect2">
<h3 id="_安装_2">7.2. 安装</h3>
<div class="paragraph">
<p>在Server3&amp;6&amp;7上执行以下操作：</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">安装Nginx YUM源</dt>
<dd>
<p><code>rpm -ivh <a href="http://nginx.org/packages/centos/6/noarch/RPMS/nginx-release-centos-6-0.el6.ngx.noarch.rpm" class="bare">http://nginx.org/packages/centos/6/noarch/RPMS/nginx-release-centos-6-0.el6.ngx.noarch.rpm</a></code></p>
</dd>
<dt class="hdlist1">安装Nginx</dt>
<dd>
<p><code>yum install -y nginx</code></p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_配置">7.3. 配置</h3>
<div class="paragraph">
<p>在Server6&amp;7上执行以下操作：</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">开机启动Nginx服务</dt>
<dd>
<p><code>chkconfig nginx on</code></p>
</dd>
<dt class="hdlist1">立即启动Nginx服务</dt>
<dd>
<p><code>service nginx start</code></p>
</dd>
</dl>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
本书不涉及具体的参数调整，仅仅需要启动Nginx，保证80端口可以访问即可。
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_测试">7.4. 测试</h3>
<div class="paragraph">
<p>在Server6&amp;7上测试Nginx服务。</p>
</div>
<div class="sect3">
<h4 id="_检查80端口">7.4.1. 检查80端口</h4>
<div class="paragraph">
<p>在终端中执行 <code>ss -t4nlp|grep ':80'</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre># ss -t4nlp|grep ':80'
LISTEN     0      128                       *:80                       *:*      users:(("nginx",20736,6),("nginx",20738,6))</pre>
</div>
</div>
<div class="paragraph">
<p>根据输出我们可以看到Nginx已经启动成功。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
netstat命令已经过时，建议使用ss命令代替。
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_测试访问">7.4.2. 测试访问</h4>
<div class="paragraph">
<p>在终端中执行 <code>curl -I localhost</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre># curl -I localhost
HTTP/1.1 200 OK
Server: nginx/1.8.0
Date: Tue, 11 Aug 2015 16:54:56 GMT
Content-Type: text/html
Content-Length: 612
Last-Modified: Tue, 21 Apr 2015 15:38:08 GMT
Connection: keep-alive
ETag: "55366ee0-264"
Accept-Ranges: bytes</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
当然，你也可以在自己的电脑上，通过浏览器 <a href="http://192.168.1.201" class="bare">http://192.168.1.201</a> 或 <a href="http://192.168.1.202" class="bare">http://192.168.1.202</a> 测试访问。
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_mysql服务">8. MySQL服务</h2>
<div class="sectionbody">
<div class="paragraph">
<p>在Server4&amp;5上，分别安装MySQL并测试。</p>
</div>
<div class="sect2">
<h3 id="_安装_3">8.1. 安装</h3>
<div class="paragraph">
<p>Server4&amp;5 分别安装并设置开机启动。</p>
</div>
<div class="paragraph">
<p><code>yum install -y mysql mysql-server</code></p>
</div>
<div class="paragraph">
<p>设置开机启动MySQL服务</p>
</div>
<div class="paragraph">
<p><code>chkconfig mysqld on</code></p>
</div>
</div>
<div class="sect2">
<h3 id="_配置_2">8.2. 配置</h3>
<div class="paragraph">
<p>初始化MySQL数据库。</p>
</div>
<div class="listingblock">
<div class="title">Server4&amp;5执行</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">ls /etc/my.cnf.init.bak &gt;/dev/null 2&gt;&amp;1 || cp /etc/my.cnf /etc/my.cnf.init.bak

sed -i 's#datadir=/var/lib/mysql#datadir=/data/mysql#g' /etc/my.cnf

mkdir /data/mysql

mysql_install_db

service mysqld start

mysqladmin -uroot password "rootpassword"</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
本书不涉及具体的参数优化，仅会设置MySQL集群需要的参数。保证3306端口能够连接即可。
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_测试_2">8.3. 测试</h3>
<div class="paragraph">
<p>分别测试Server4&amp;5</p>
</div>
<div class="sect3">
<h4 id="_检查3306端口">8.3.1. 检查3306端口</h4>
<div class="paragraph">
<p>在终端中执行 <code>ss -t4nlp|grep ':3306'</code></p>
</div>
<div class="listingblock">
<div class="title">Server4&amp;5输出</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-console" data-lang="console"># ss -t4nlp|grep ':3306'
LISTEN     0      50                        *:3306                     *:*      users:(("mysqld",22131,10))</code></pre>
</div>
</div>
<div class="paragraph">
<p>根据输出我们可以看到MySQL已经启动成功。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
netstat命令已经过时，建议使用ss命令代替。
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_测试连接">8.3.2. 测试连接</h4>
<div class="paragraph">
<p>在终端中执行 <code>mysql -uroot -prootpassword</code></p>
</div>
<div class="listingblock">
<div class="title">Server4&amp;5输出</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-console" data-lang="console"># mysql -uroot -prootpassword
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 3
Server version: 5.1.73 Source distribution

Copyright (c) 2000, 2013, Oracle and/or its affiliates. All rights reserved.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_常见的复制模式">8.4. 常见的复制模式</h3>
<div class="paragraph">
<p>本节内容摘录自 <a href="http://www.mysql.com/why-mysql/white-papers/wp-mysql-5-5-replication-zh">《MySQL Replication(复制) - 用MySQL5.5提高可扩展性和可用性》</a></p>
</div>
<div class="paragraph">
<p>MySQL支持多种不同的复制拓扑。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="image/4-常见的MySQL复制拓扑.jpg" alt="常见的MySQL复制拓扑">
</div>
<div class="title">Figure 1: 常见的MySQL复制拓扑</div>
</div>
<div class="sect3">
<h4 id="_主从">8.4.1. 主从</h4>
<div class="paragraph">
<p>这是最常见的也是最易于配置和管理的拓扑形式。在这种拓扑下我们有两台服务器,一台做主机,一台做从机。写操作都在主机上执行而
读操作可以分散到主机和从机之间 。</p>
</div>
</div>
<div class="sect3">
<h4 id="_一主多从">8.4.2. 一主多从</h4>
<div class="paragraph">
<p>这种场景下多台从机连到主机。这可以大幅度水平扩展系统,但代价是增加了管理成本。</p>
</div>
</div>
<div class="sect3">
<h4 id="_多主">8.4.3. 多主</h4>
<div class="paragraph">
<p>在主/主配置下,两台服务器组合成一个链,互为主从。虽然,这种配置带来了能够在任一个系统中写数据的好处,但确实明显增加了设置、
配置和管理的复杂度。另外,除非你用MySQLCluster,否则不会有冲突检测机制以至于应用程序必须确定不去更新还没有被复制的行。也可
以用几台MySQL服务器搭成环状,得到更高水平的扩展性和性能(假设应用程序能避免向不同服务器的相同的行发送冲突的更新数据)。
MySQL5.5 引入了新的过滤特性,能够更好地处理当一台服务器正在更新复制到环中其他服务器时发生故障的情况。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="image/4-多主环.jpg" alt="多主环">
</div>
<div class="title">Figure 2: 多主环</div>
</div>
<div class="paragraph">
<p>当在使用多主复制的同时用了自动增长的列,你应该在每台服务器上使用auto_increment_offset和auto_increment_increment参数来确
保不会重复分配值。例如两台服务器的情况如下图所示。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="image/4-避免自动增长冲突的参数值.jpg" alt="避免自动增长冲突的参数值">
</div>
<div class="title">Figure 3: 避免自动增长冲突的参数值</div>
</div>
<div class="paragraph">
<p>多主一从(多源)
MySQL目前还不支持这种复制拓扑。在多主的配置下,从机基本上“为两台主机服务”,意味着从机从超过一台的主机复制变化。由于MySQL
Cluster允许多台MySQL服务器写到同一个Cluster,因此在一些合适的应用场景,如果需要的话配置这种功能是可能的(每台MySQL服务器仅
仅是一台主机的从机)。</p>
</div>
</div>
<div class="sect3">
<h4 id="_复制模式的选择">8.4.4. 复制模式的选择</h4>
<div class="paragraph">
<p>MySQL的主-主复制架构是企业环境中常见的解决方案。此方案具备高可用、可扩展、易管理的特点。主主复制是通
过两台MySQL Server通过MySQL Replication互为主从。两台MySQL Server互相将对方作为自己的（主库）Master，自己又同时作为
对方的（备库）Slave来进行复制。实现高可用架构中的数据同步功能，下文将介绍的Keepalived实现高可用架构中的故障迁移功能。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">优点</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>数据同步写入，多点读取</p>
</li>
<li>
<p>配合Keepalived能做完善的高可用框架</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">缺点</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>自动增长的列冲突(配置参数解决)</p>
</li>
<li>
<p>MySQL Server数量增加时，明显增加了配置管理的复杂度(本书演示集群只有两台，复杂度可以忽略不计)</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>所以，我们选择 <strong><span class="red">多主(主-主)复制模式</span></strong>。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_mysql配置文件">8.5. MySQL配置文件</h3>
<div class="listingblock">
<div class="title">Server4执行</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">rm -f /etc/my.cnf
wget -c http://fifilyu.github.io/halcpgb/file/Server4.etc.my.cnf -O /etc/my.cnf

mkdir /data2/mysql_binlogs
chown -R mysql /data2/mysql_binlogs
service mysqld restart</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Server5执行</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">rm -f /etc/my.cnf
wget -c http://fifilyu.github.io/halcpgb/file/Server5.etc.my.cnf -O /etc/my.cnf

mkdir /data2/mysql_binlogs
chown -R mysql /data2/mysql_binlogs
service mysqld restart</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>sync_binlog，innodb_flush_log_at_trx_commit，innodb_support_xa三个选项都是出于安全目的设置的，不是复制的必须选项。
如果没设置的话，一旦主服务器宕机，数据可能来不及写入磁盘，从而导致从服务器在复制过程中出现类似下面的错误：</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Client requested master to start replication from impossible position</pre>
</div>
</div>
<div class="paragraph">
<p>因为日志数据已经丢失了。
所以此类问题基本上不能处理，只能重新安装同步从服务器。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_主_主复制">8.6. 主-主复制</h3>
<div class="sect3">
<h4 id="_配置server4_server5主从复制">8.6.1. 配置Server4-Server5主从复制</h4>
<div class="sect4">
<h5 id="_server4_第一mysql主服务器">Server4，第一MySQL主服务器</h5>
<div class="paragraph">
<p>主-主模式，两个MySQL服务器中，其中一个宕机。当恢复正常时，主-主之间会相互进行同步，可能出现死锁和IO问题。所以，其中一个MySQL服务器默认不启动slave服务。本书设置如下：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>第二MySQL从服务器(Server4)默认不启动slave服务。脚本(/opt/check_mysql_slave.sh)每两分钟检测一次slave服务，如未启动slave服务则启动之</p>
</li>
<li>
<p>第一MySQL从服务器(Server5)默认启动slave服务</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Server4执行</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">cat &lt;&lt;EOF &gt;/opt/check_mysql_slave.sh
mysql_cmd="/usr/bin/mysql -uroot -prootpassword -e"
\$mysql_cmd "show slave status\G;"|grep "Slave_IO_Running: Yes" &gt;/dev/null || \$mysql_cmd "start slave;"
EOF

echo "*/2 * * * * /bin/sh /opt/check_mysql_slave.sh &gt;/dev/null 2&gt;&amp;1" &gt;&gt; /var/spool/cron/root</code></pre>
</div>
</div>
<div class="paragraph">
<p>在Server4上，登录MySQL Shell：</p>
</div>
<div class="paragraph">
<p><code>mysql -uroot -prootpassword</code></p>
</div>
<div class="paragraph">
<p>在MySQL Shell中执行</p>
</div>
<div class="listingblock">
<div class="title">Server5执行</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">SHOW MASTER STATUS;

grant all privileges on *.* to root@"10.10.10.70"  identified by 'rootpassword';

grant all privileges on *.* to root@"10.10.10.80"  identified by 'rootpassword';

grant all privileges on *.* to root@"10.10.10.100"  identified by 'rootpassword';

grant all privileges on *.* to root@"10.10.10.201"  identified by 'rootpassword';

grant all privileges on *.* to root@"10.10.10.202"  identified by 'rootpassword';

grant replication slave on *.* to slaveuser@"13.13.13.101"  identified by 'slaveuserpassword';

grant replication slave on *.* to slaveuser@"13.13.13.102"  identified by 'slaveuserpassword';

flush privileges;</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
13.13.13.0/24是Server4&amp;5服务器之间使用千兆网线直连的网络。允许Keepalived和Nginx服务器(10.10.10.70&amp;80&amp;201&amp;202)可以远程访问MySQL。
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Server4输出</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-console" data-lang="console"># mysql -uroot -prootpassword
......
mysql&gt; SHOW MASTER STATUS;
+------------------+----------+--------------+------------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |
+------------------+----------+--------------+------------------+
| mysql-bin.000001 |      106 |              |                  |
+------------------+----------+--------------+------------------+
1 row in set (0.00 sec)

mysql&gt; grant all privileges on *.* to root@"10.10.10.70" identified by 'slaveuserpassword';
Query OK, 0 rows affected (0.01 sec)

mysql&gt; grant all privileges on *.* to root@"10.10.10.80" identified by 'slaveuserpassword';
Query OK, 0 rows affected (0.02 sec)

mysql&gt; grant all privileges on *.* to root@"10.10.10.100" identified by 'slaveuserpassword';
Query OK, 0 rows affected (0.02 sec)

mysql&gt; grant replication slave on *.* to root@"10.10.10.201" identified by 'slaveuserpassword';
Query OK, 0 rows affected (0.02 sec)

mysql&gt; grant replication slave on *.* to root@"10.10.10.202" identified by 'slaveuserpassword';
Query OK, 0 rows affected (0.02 sec)

mysql&gt; grant replication slave on *.* to slaveuser@"13.13.13.101" identified by 'slaveuserpassword';
Query OK, 0 rows affected (0.02 sec)

mysql&gt; grant replication slave on *.* to slaveuser@"13.13.13.102" identified by 'slaveuserpassword';
Query OK, 0 rows affected (0.02 sec)

mysql&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>按Ctrl+C退出MySQL Shell。</p>
</div>
<div class="paragraph">
<p>获取到列“File”的值mysql-bin.000001，列“Position”的值106。</p>
</div>
<div class="paragraph">
<p>此时，Server4上的MySQL不要做任何。防止主服务器状态值变化。</p>
</div>
</div>
<div class="sect4">
<h5 id="_server5_第一mysql从服务器">Server5，第一MySQL从服务器</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>设置第一MySQL从服务器</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>登录MySQL Shell：</p>
</div>
<div class="paragraph">
<p><code>mysql -uroot -prootpassword</code></p>
</div>
<div class="paragraph">
<p>在MySQL Shell中执行：</p>
</div>
<div class="listingblock">
<div class="title">Server2执行</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-console" data-lang="console">change master to master_host='13.13.13.101',
master_user='slaveuser',
master_password='slaveuserpassword',
master_log_file='mysql-bin.000001',
master_log_pos=106;

start slave;

show slave status\G;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Server5输出</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-console" data-lang="console"># mysql -uroot -prootpassword
......
mysql&gt; change master to master_host='13.13.13.101',
    -&gt; master_user='slaveuser',
    -&gt; master_password='slaveuserpassword',
    -&gt; master_log_file='mysql-bin.000001',
    -&gt; master_log_pos=450;
Query OK, 0 rows affected (0.04 sec)

mysql&gt; start slave;
Query OK, 0 rows affected (0.00 sec)

mysql&gt; show slave status\G;
*************************** 1. row ***************************
               Slave_IO_State: Waiting for master to send event
                  Master_Host: 13.13.13.101
                  Master_User: slaveuser
                  Master_Port: 3306
                Connect_Retry: 60
              Master_Log_File: mysql-bin.000001
          Read_Master_Log_Pos: 450
               Relay_Log_File: mysql-relay-bin.000002
                Relay_Log_Pos: 595
        Relay_Master_Log_File: mysql-bin.000001
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes
......
                Last_IO_Errno: 0
                Last_IO_Error:
               Last_SQL_Errno: 0
               Last_SQL_Error:
1 row in set (0.00 sec)

ERROR:
No query specified

mysql&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>如果Slave_IO_Running和Slave_SQL_Running状态为Yes，Last_SQL_Errno为0，则表示主从配置成功。</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_配置server5_server4主从复制">8.6.2. 配置Server5-Server4主从复制</h4>
<div class="sect4">
<h5 id="_server5_第二mysql主服务器">Server5，第二MySQL主服务器</h5>
<div class="paragraph">
<p>查看Master状态</p>
</div>
<div class="listingblock">
<div class="title">Server5执行</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-console" data-lang="console">mysql -uroot -prootpassword -e "SHOW MASTER STATUS;"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Server5输出</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-console" data-lang="console"># mysql -uroot -prootpassword -e "SHOW MASTER STATUS;"
+------------------+----------+--------------+------------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |
+------------------+----------+--------------+------------------+
| mysql-bin.000001 |      450 |              |                  |
+------------------+----------+--------------+------------------+
1 row in set (0.00 sec)</code></pre>
</div>
</div>
<div class="paragraph">
<p>按Ctrl+C退出MySQL Shell。</p>
</div>
<div class="paragraph">
<p>获取到列“File”的值mysql-bin.000001，列“Position”的值450。</p>
</div>
</div>
<div class="sect4">
<h5 id="_server4_第二mysql从服务器">Server4，第二MySQL从服务器</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>设置第二MySQL从服务器</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>登录Server4的MySQL Shell执行</p>
</div>
<div class="listingblock">
<div class="title">Server4执行</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-console" data-lang="console">change master to master_host='13.13.13.102',
master_user='slaveuser',
master_password='slaveuserpassword',
master_log_file='mysql-bin.000001',
master_log_pos=450;

start slave;

show slave status\G;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Server4输出</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-console" data-lang="console"># mysql -uroot -prootpassword
......
mysql&gt; change master to master_host='13.13.13.102',
    -&gt; master_user='slaveuser',
    -&gt; master_password='slaveuserpassword',
    -&gt; master_log_file='mysql-bin.000001',
    -&gt; master_log_pos=450;
Query OK, 0 rows affected (0.02 sec)

mysql&gt; start slave;
Query OK, 0 rows affected (0.00 sec)

mysql&gt; show slave status\G;
*************************** 1. row ***************************
               Slave_IO_State: Waiting for master to send event
                  Master_Host: 13.13.13.102
                  Master_User: slaveuser
                  Master_Port: 3306
                Connect_Retry: 60
              Master_Log_File: mysql-bin.000001
          Read_Master_Log_Pos: 450
               Relay_Log_File: mysql-relay-bin.000002
                Relay_Log_Pos: 251
        Relay_Master_Log_File: mysql-bin.000001
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes
.....
                Last_IO_Errno: 0
                Last_IO_Error:
               Last_SQL_Errno: 0
               Last_SQL_Error:
1 row in set (0.00 sec)

ERROR:
No query specified</code></pre>
</div>
</div>
<div class="paragraph">
<p>如果Slave_IO_Running和Slave_SQL_Running状态为Yes，Last_SQL_Errno为0，则表示主从配置成功。</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_测试_3">8.6.3. 测试</h4>
<div class="sect4">
<h5 id="_测试server4_server5主从">测试Server4-Server5主从</h5>
<div class="paragraph">
<p>在第一主库上创建数据库 <code>testdb</code> ，在第一从库查看是否同步创建。</p>
</div>
<div class="listingblock">
<div class="title">Server4 MySQL Shell</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-console" data-lang="console"># mysql -uroot -prootpassword
......
mysql&gt; create database testdb;
Query OK, 1 row affected (0.01 sec)

mysql&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Server5 MySQL Shell</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-console" data-lang="console"># mysql -uroot -prootpassword
......
mysql&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| test               |
| testdb             |
+--------------------+
4 rows in set (0.00 sec)

mysql&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_测试server5_server4主从">测试Server5-Server4主从</h5>
<div class="paragraph">
<p>在第二主库上删除数据库 <code>testdb</code> ，在第二从库查看是否同步删除。</p>
</div>
<div class="listingblock">
<div class="title">Server5 MySQL Shell</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-console" data-lang="console"># mysql -uroot -prootpassword
......
mysql&gt; drop database testdb;
Query OK, 0 rows affected (0.04 sec)

mysql&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Server4 MySQL Shell</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-console" data-lang="console"># mysql -uroot -prootpassword
......
mysql&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| test               |
+--------------------+
3 rows in set (0.00 sec)

mysql&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_lvs与keepalived服务">9. LVS与Keepalived服务</h2>
<div class="sectionbody">
<div class="paragraph">
<p>本章是本书的重点，介绍和演示如何安装配置LVS与Keepalived服务。</p>
</div>
<div class="sect2">
<h3 id="_安装_4">9.1. 安装</h3>
<div class="paragraph">
<p>在Server1&amp;2上安装包ipvsadm以及keepalived</p>
</div>
<div class="paragraph">
<p><code>yum install -y ipvsadm keepalived</code></p>
</div>
</div>
<div class="sect2">
<h3 id="_lvs工作模式与负载调度算法">9.2. LVS工作模式与负载调度算法</h3>
<div class="paragraph">
<p>本节内容摘录自 <a href="http://www.linuxvirtualserver.org/zh/lvs1.html" class="bare">http://www.linuxvirtualserver.org/zh/lvs1.html</a></p>
</div>
<div class="sect3">
<h4 id="_工作模式">9.2.1. 工作模式</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Virtual Server via Network Address Translation（VS/NAT）</p>
<div class="literalblock">
<div class="content">
<pre>通过网络地址转换，调度器重写请求报文的目标地址，根据预设的调度算法，将请求分派给后端的真实服务器；真实服务器的响应报文通过调度器时，报文的源地址被重写，再返回给客户，完成整个负载调度过程。</pre>
</div>
</div>
</li>
<li>
<p>Virtual Server via IP Tunneling（VS/TUN）</p>
<div class="literalblock">
<div class="content">
<pre>采用NAT技术时，由于请求和响应报文都必须经过调度器地址重写，当客户请求越来越多时，调度器的处理能力将成为瓶颈。为了解决这个问题，调度器把请求报文通过IP隧道转发至真实服务器，而真实服务器将响应直接返回给客户，所以调度器只处理请求报文。由于一般网络服务应答比请求报文大许多，采用 VS/TUN技术后，集群系统的最大吞吐量可以提高10倍。</pre>
</div>
</div>
</li>
<li>
<p>Virtual Server via Direct Routing（VS/DR）</p>
<div class="literalblock">
<div class="content">
<pre>VS/DR通过改写请求报文的MAC地址，将请求发送到真实服务器，而真实服务器将响应直接返回给客户。同VS/TUN技术一样，VS/DR技术可极大地提高集群系统的伸缩性。这种方法没有IP隧道的开销，对集群中的真实服务器也没有必须支持IP隧道协议的要求，但是要求调度器与真实服务器都有一块网卡连 在同一物理网段上。</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_负载调度算法">9.2.2. 负载调度算法</h4>
<div class="paragraph">
<p>针对不同的网络服务需求和服务器配置，IPVS调度器实现了如下八种负载调度算法：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>轮叫（Round Robin）</p>
<div class="literalblock">
<div class="content">
<pre>调度器通过"轮叫"调度算法将外部请求按顺序轮流分配到集群中的真实服务器上，它均等地对待每一台服务器，而不管服务器上实际的连接数和系统负载。</pre>
</div>
</div>
</li>
<li>
<p>加权轮叫（Weighted Round Robin）</p>
<div class="literalblock">
<div class="content">
<pre>调度器通过"加权轮叫"调度算法根据真实服务器的不同处理能力来调度访问请求。这样可以保证处理能力强的服务器处理更多的访问流量。调度器可以自动问询真实服务器的负载情况，并动态地调整其权值。</pre>
</div>
</div>
</li>
<li>
<p>最少链接（Least Connections）</p>
<div class="literalblock">
<div class="content">
<pre>调度器通过"最少连接"调度算法动态地将网络请求调度到已建立的链接数最少的服务器上。如果集群系统的真实服务器具有相近的系统性能，采用"最小连接"调度算法可以较好地均衡负载。</pre>
</div>
</div>
</li>
<li>
<p>加权最少链接（Weighted Least Connections）</p>
<div class="literalblock">
<div class="content">
<pre>在集群系统中的服务器性能差异较大的情况下，调度器采用"加权最少链接"调度算法优化负载均衡性能，具有较高权值的服务器将承受较大比例的活动连接负载。调度器可以自动问询真实服务器的负载情况，并动态地调整其权值。</pre>
</div>
</div>
</li>
<li>
<p>基于局部性的最少链接（Locality-Based Least Connections）</p>
<div class="literalblock">
<div class="content">
<pre>"基于局部性的最少链接"调度算法是针对目标IP地址的负载均衡，目前主要用于Cache集群系统。该算法根据请求的目标IP地址找出该目标IP地址最近使用的服务器，若该服务器是可用的且没有超载，将请求发送到该服务器；若服务器不存在，或者该服务器超载且有服务器处于一半的工作负载，则用"最少链接"的原则选出一个可用的服务 器，将请求发送到该服务器。</pre>
</div>
</div>
</li>
<li>
<p>带复制的基于局部性最少链接（Locality-Based Least Connections with Replication）</p>
<div class="literalblock">
<div class="content">
<pre>"带复制的基于局部性最少链接"调度算法也是针对目标IP地址的负载均衡，目前主要用于Cache集群系统。它与LBLC算法的不同之处是它要维护从一个目标IP地址到一组服务器的映射，而LBLC算法维护从一个目标IP地址到一台服务器的映射。该算法根据请求的目标IP地址找出该目标IP地址对应的服务器组，按"最小连接"原则从服务器组中选出一台服务器，若服务器没有超载，将请求发送到该服务器，若服务器超载；则按"最小连接"原则从这个集群中选出一台服务器，将该服务器加入到服务器组中，将请求发送到该服务器。同时，当该服务器组有一段时间没有被修改，将最忙的服务器从服务器组中删除，以降低复制的程度。</pre>
</div>
</div>
</li>
<li>
<p>目标地址散列（Destination Hashing）</p>
<div class="literalblock">
<div class="content">
<pre>"目标地址散列"调度算法根据请求的目标IP地址，作为散列键（Hash Key）从静态分配的散列表找出对应的服务器，若该服务器是可用的且未超载，将请求发送到该服务器，否则返回空。</pre>
</div>
</div>
</li>
<li>
<p>源地址散列（Source Hashing）</p>
<div class="literalblock">
<div class="content">
<pre>"源地址散列"调度算法根据请求的源IP地址，作为散列键（Hash Key）从静态分配的散列表找出对应的服务器，若该服务器是可用的且未超载，将请求发送到该服务器，否则返回空。</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_选择_2">9.2.3. 选择</h4>
<div class="paragraph">
<p>本书演示的集群是构建在同一个物理网络下，并且需要简单易学。所以，我们选择</p>
</div>
<div class="ulist">
<ul>
<li>
<p>工作模式选择VS/DR</p>
</li>
<li>
<p>负载调度算法选择轮叫(rr)</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_lvs体验">9.3. LVS体验</h3>
<div class="paragraph">
<p>本节仅仅体验如何使用LVS。此时不会修改任何系统配置文件，所有设置都是重启后即被还原。</p>
</div>
<div class="sect3">
<h4 id="_director">9.3.1. Director</h4>
<div class="listingblock">
<div class="title">Server1执行</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">ip addr add 192.168.1.200/24 broadcast 192.168.1.255 dev eth0

ipvsadm -A -t 192.168.1.200:80 -s rr
ipvsadm -a -t 192.168.1.200:80 -r 10.10.10.201 -g
ipvsadm -a -t 192.168.1.200:80 -r 10.10.10.202 -g</code></pre>
</div>
</div>
<div class="paragraph">
<p>通过命令 <code>ipvsadm -ln</code> 查看增加的LVS设置</p>
</div>
<div class="listingblock">
<div class="title">Server1输出</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash"># ipvsadm -ln
IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  192.168.1.200:80 rr
  -&gt; 10.10.10.201:80              Route   1      0          0
  -&gt; 10.10.10.202:80              Route   1      0          0</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_说明">说明</h5>
<div class="dlist">
<dl>
<dt class="hdlist1">ip addr add 192.168.1.200/24 broadcast 192.168.1.255 dev eth0</dt>
<dd>
<p>增加192.168.1.200到网卡eth0</p>
</dd>
<dt class="hdlist1">ipvsadm -A -t 192.168.1.200:80 -s rr</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>-A 增加虚拟服务器</p>
</li>
<li>
<p>-t 虚拟服务地址[:端口]</p>
</li>
<li>
<p>-s 负载调度算法，rr表示轮叫</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">ipvsadm -a -t 192.168.1.200:80 -r 10.10.10.201 -g</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>-a 增加真实服务</p>
</li>
<li>
<p>-r 虚拟服务地址</p>
</li>
<li>
<p>-g LVS工作模式：VS/DR</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>更多ipvsadm信息，请 <code>ipvsadm --help</code> 查看</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_real_server_server6_7">9.3.2. Real Server(Server6&amp;7)</h4>
<div class="listingblock">
<div class="title">Server6&amp;7执行</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">ip addr add 192.168.1.200/32 dev lo
ip route add 192.168.1.200/32 dev lo

sysctl -w net.ipv4.conf.lo.arp_ignore=1
sysctl -w net.ipv4.conf.lo.arp_announce=2
sysctl -w net.ipv4.conf.all.arp_ignore=1
sysctl -w net.ipv4.conf.all.arp_announce=2</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_说明_2">说明</h5>
<div class="dlist">
<dl>
<dt class="hdlist1">ip addr add 192.168.1.200/32 dev lo</dt>
<dd>
<p>增加192.168.1.200到网卡lo</p>
</dd>
<dt class="hdlist1">ip route add 192.168.1.200/32 dev lo</dt>
<dd>
<p>增加192.168.1.200路由</p>
</dd>
<dt class="hdlist1"><code>arp_ignore</code> 和 <code>arp_announce</code></dt>
<dd>
<p>使真实服务器不回应网卡lo以外的arp包</p>
</dd>
</dl>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<code>*.arp_ignore</code> 和 <code>all.arp_ignore</code> 值不同时，取值最大的值生效。
lo.arp_ignore=0,all.arp_ignore=1，生效的是1。所以，网卡和all必须同时设置。
sysctl所有参数的取值模式都是这样。
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_参数文档">参数文档</h5>
<div class="listingblock">
<div class="title">arp_announce - INTEGER</div>
<div class="content">
<pre>Define different restriction levels for announcing the local source IP address from IP packets in ARP requests sent on interface:

0 - (default) Use any local address, configured on any interface

1 - Try to avoid local addresses that are not in the target's subnet for this interface. This mode is useful when target hosts reachable via this interface require the source IP address in ARP requests to be part of their logical network configured on the receiving interface. When we generate the request we will check all our subnets that include the target IP and will preserve the source address if it is from such subnet. If there is no such subnet we select source address according to the rules for level 2.

2 - Always use the best local address for this target. In this mode we ignore the source address in the IP packet and try to select local address that we prefer for talks with the target host. Such local address is selected by looking for primary IP addresses on all our subnets on the outgoing interface that include the target IP address. If no suitable local address is found we select the first local address. we have on the outgoing interface or on all other interfaces, with the hope we will receive reply for our request and even sometimes no matter the source IP address we announce.

The max value from conf/{all,interface}/arp_announce is used.

Increasing the restriction level gives more chance for receiving answer from the resolved target while decreasing the level announces more valid sender's information.</pre>
</div>
</div>
<div class="listingblock">
<div class="title">arp_ignore - INTEGER</div>
<div class="content">
<pre>Define different modes for sending replies in response to received ARP requests that resolve local target IP addresses:

0 - (default): reply for any local target IP address, configured on any interface

1 - reply only if the target IP address is local address configured on the incoming interface

2 - reply only if the target IP address is local address configured on the incoming interface and both with the sender's IP address are part from same subnet on this interface

3 - do not reply for local addresses configured with scope host, only resolutions for global and link addresses are replied

4-7 - reserved

8 - do not reply for all local addresses

The max value from conf/{all,interface}/arp_ignore is used when ARP request is received on the {interface}</pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_测试_4">9.3.3. 测试</h4>
<div class="sect4">
<h5 id="_创建测试页面">创建测试页面</h5>
<div class="listingblock">
<div class="title">Server6&amp;7执行</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">html_page=/usr/share/nginx/html/index.html
ip_addr=`ip a|grep '10.10.10'|awk '{print $2}'|awk -F'/' '{print $1}'`

echo '&lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8"&gt;' &gt;$html_page
echo "这个是一个测试页面。&lt;br&gt;"&gt;&gt;$html_page
echo "你看到内容来自 Real Server: $ip_addr" &gt;&gt;$html_page</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="lvs_test">测试访问</h5>
<div class="paragraph">
<p>在浏览器里面访问 <a href="http://192.168.1.200" class="bare">http://192.168.1.200</a> 。
我们有两台Real Server，应该有的效果是每次刷新网页，会显示不同的内容。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
为了测试的准确性，请直接使用 <strong><span class="red">Ctrl+F5强制刷新</span></strong> 网页，这样浏览器才不会显示缓存的内容。
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">浏览器输出</div>
<div class="content">
<pre>这个是一个测试页面。
你看到内容来自 Real Server: 10.10.10.201</pre>
</div>
</div>
<div class="listingblock">
<div class="title">浏览器输出</div>
<div class="content">
<pre>这个是一个测试页面。
你看到内容来自 Real Server: 10.10.10.202</pre>
</div>
</div>
<div class="paragraph">
<p>通过命令 <code>ipvsadm -ln</code> 查看访问分配情况</p>
</div>
<div class="listingblock">
<div class="title">Server1输出</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash"># ipvsadm -ln
IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  192.168.1.200:80 rr
  -&gt; 10.10.10.201:80              Route   1      1          2
  -&gt; 10.10.10.202:80              Route   1      0          2</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">ActiveConn</dt>
<dd>
<p>活动连接数,也就是TCP连接状态的ESTABLISHED</p>
</dd>
<dt class="hdlist1">InActConn</dt>
<dd>
<p>除了状态是ESTABLISHED的TCP连接</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>当LVS配置成功后，不断的访问 <code>ActiveConn</code> 和 <code>InActConn</code> 会持续变化。
两个值都为0时，说明LVS配置出现错误。</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_清空临时配置">9.3.4. 清空临时配置</h4>
<div class="paragraph">
<p>重启Server1&amp;6&amp;7，清空所有临时配置。</p>
</div>
</div>
<div class="sect3">
<h4 id="_总结">9.3.5. 总结</h4>
<div class="paragraph">
<p>本章只是为后面Keepalived的学习做一些铺垫。熟悉LVS原理和使用后，更加容易理解Keepalived。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_keepalived配置文件">9.4. Keepalived配置文件</h3>
<div class="listingblock">
<div class="title">Server1执行</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">#备份默认配置文件
ls /etc/keepalived/keepalived.conf.init.bak &gt;/dev/null 2&gt;&amp;1 || cp /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.init.bak

#删除默认配置文件
rm -f /etc/keepalived/keepalived.conf

#下载配置文件
wget -c http://fifilyu.github.io/halcpgb/file/Server1.etc.keepalived.keepalived.conf -O /etc/keepalived/keepalived.conf</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Server2执行</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">#备份默认配置文件
ls /etc/keepalived/keepalived.conf.init.bak &gt;/dev/null 2&gt;&amp;1 || cp /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.init.bak

#删除默认配置文件
rm -f /etc/keepalived/keepalived.conf

#下载配置文件
wget -c http://fifilyu.github.io/halcpgb/file/Server2.etc.keepalived.keepalived.conf -O /etc/keepalived/keepalived.conf</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_keepalived环境配置">9.5. Keepalived环境配置</h3>
<div class="sect3">
<h4 id="_keepalived_2">9.5.1. Keepalived</h4>
<div class="listingblock">
<div class="title">Server1&amp;2执行</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">echo "/sbin/service keepalived stop" &gt;/opt/stop_keepalived.sh
echo "/sbin/service keepalived status|grep '(pid ' || /sbin/service keepalived start" &gt;/opt/check_keepalived.sh
chmod +x /opt/stop_keepalived.sh /opt/check_keepalived.sh

#增加计划任务，每分钟执行一次脚本。当Keepalived服务停止时，该脚本会启动服务
#此任务与Keepalived配置文件中使用/opt/stop_keepalived.sh脚本结合起来，组成了一个启动和停止服务的环路。
#配合实现MySQL的高可用框架。
echo "*/1 * * * * /bin/sh /opt/check_keepalived.sh &gt;/dev/null 2&gt;&amp;1" &gt;&gt; /var/spool/cron/root

chkconfig keepalived on
service keepalived start

ipvsadm -ln</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>当服务器(Server1&amp;2)的Keepalived(vrrp_instance)为Master状态时，无法访问以下地址：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>192.168.1.200的80端口</p>
</li>
<li>
<p>10.10.10.100的3306端口</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>细心的话，会发现我们使用Keepalived对80端口和3306端口做了高可用和负载均衡。</p>
</div>
<div class="paragraph">
<p>也就是说，Keepavelid将VIP绑定到网卡上时，本机无法访问VIP+Keepalived监控的端口。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_real_server">9.5.2. Real Server</h4>
<div class="sect4">
<h5 id="_server4_5">Server4&amp;5</h5>
<div class="listingblock">
<div class="title">Server4&amp;5执行</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">cat &lt;&lt; EOF &gt; /etc/sysconfig/network-scripts/ifcfg-lo:vip
DEVICE=lo:vip
BOOTPROTO=none
IPADDR=10.10.10.100
NETMASK=255.255.255.255
EOF

cat &lt;&lt; EOF &gt; /etc/sysconfig/network-scripts/route-lo
10.10.10.100/32 dev lo
EOF

#当前系统生效
ip addr add 10.10.10.100/32 dev lo
ip route add 10.10.10.100/32 dev lo

cat &lt;&lt;EOF &gt;&gt;/etc/sysctl.conf
net.ipv4.conf.lo.arp_ignore = 1
net.ipv4.conf.lo.arp_announce = 2
net.ipv4.conf.all.arp_ignore = 1
net.ipv4.conf.all.arp_announce = 2
EOF

sysctl -p</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_server6_7">Server6&amp;7</h5>
<div class="listingblock">
<div class="title">Server6&amp;7执行</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">cat &lt;&lt; EOF &gt; /etc/sysconfig/network-scripts/ifcfg-lo:vip
DEVICE=lo:vip
BOOTPROTO=none
IPADDR=192.168.1.200
NETMASK=255.255.255.255
EOF

cat &lt;&lt; EOF &gt; /etc/sysconfig/network-scripts/route-lo
192.168.1.200/32 dev lo
EOF

#当前系统生效
ip addr add 192.168.1.200/32 dev lo
ip route add 192.168.1.200/32 dev lo

cat &lt;&lt;EOF &gt;&gt;/etc/sysctl.conf
net.ipv4.conf.lo.arp_ignore = 1
net.ipv4.conf.lo.arp_announce = 2
net.ipv4.conf.all.arp_ignore = 1
net.ipv4.conf.all.arp_announce = 2
EOF

sysctl -p</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_测试_5">9.6. 测试</h3>
<div class="sect3">
<h4 id="_测试web服务负载均衡">9.6.1. 测试Web服务负载均衡</h4>
<div class="paragraph">
<p>Web访问测试，和之前 <a href="#lvs_test">LVS-测试访问</a> 一样。</p>
</div>
<div class="paragraph">
<p>反复停止Server1/2上的Keepalived服务，观察VIP地址192.168.1.200以及10.10.10.100是否在两台服务器之间来回切换。
反复停止Server6/7上的Nginx服务，观察访问 <a href="http://192.168.1.200" class="bare">http://192.168.1.200</a> 会有什么变化。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">停止Nginx服务</dt>
<dd>
<p>service nginx stop</p>
</dd>
</dl>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_测试数据库服务高可用">9.6.2. 测试数据库服务高可用</h4>
<div class="paragraph">
<p>在Server6&amp;7上连接MySQL测试。</p>
</div>
<div class="listingblock">
<div class="title">Server6&amp;7执行</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-console" data-lang="console">mysql -h 10.10.10.100 -uroot -prootpassword -e "SELECT @@hostname hostname;"</code></pre>
</div>
</div>
<div class="paragraph">
<p>如果成功，则能看到 <strong>Server5</strong> 字样。</p>
</div>
<div class="listingblock">
<div class="title">Server6&amp;7输出</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-console" data-lang="console"># mysql -h 10.10.10.100 -uroot -prootpassword -e "SELECT @@hostname hostname;"
+----------+
| hostname |
+----------+
| Server5  |
+----------+</code></pre>
</div>
</div>
<div class="paragraph">
<p>此时，如果停止Server5上的Keepalived服务，执行同样的命令，会看到 <strong>Server4</strong> 字样。表示MySQL高可用配置成功。</p>
</div>
<div class="listingblock">
<div class="title">Server6&amp;7输出</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-console" data-lang="console"># mysql -h 10.10.10.100 -uroot -prootpassword -e "SELECT @@hostname hostname;"
+----------+
| hostname |
+----------+
| Server4  |
+----------+</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">停止MySQL服务</dt>
<dd>
<p>service mysqld stop</p>
</dd>
</dl>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_nfs文件存储">10. NFS文件存储</h2>
<div class="sectionbody">
<div class="paragraph">
<p>本章是本书的重点之一，演示如何配置并使用NFS作共享存储，一般是用来存储静态文件。</p>
</div>
<div class="paragraph">
<p>在Web领域，网页文件一般分为两大类：</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">动态文件</dt>
<dd>
<p>由某种编程语言(Python、Ruby、C/C++、PHP、JSP、JAVA等)书写的文件。这种文件需要Web容器(Apache、Nginx、Tomcat等)转换为HTML，才能被浏览器显示为网页。比如，.py、.php、.jsp等等</p>
</dd>
<dt class="hdlist1">静态文件</dt>
<dd>
<p>不需要Web容器(Apache、Nginx、Tomcat等)也能被浏览器显示的文件。比如，.js、.css、图片(.jpg/.png/.gif)等等</p>
</dd>
</dl>
</div>
<div class="sect2">
<h3 id="_安装_5">10.1. 安装</h3>
<div class="paragraph">
<p>在Server2&amp;3&amp;6&amp;7上安装包nfs-utils以及rpcbind</p>
</div>
<div class="paragraph">
<p><code>yum install -y nfs-utils rpcbind</code></p>
</div>
<div class="paragraph">
<p>其中，Server3为NFS服务端，Server2&amp;6&amp;7为NFS客户端。</p>
</div>
<div class="paragraph">
<p>在Server3设置开机启动</p>
</div>
<div class="listingblock">
<div class="title">Server3执行</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">chkconfig rpcbind on
chkconfig nfs on</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_文档">10.2. 文档</h3>
<div class="sect3">
<h4 id="_服务端文档">10.2.1. 服务端文档</h4>
<div class="paragraph">
<p>有两种方法配置NFS服务端</p>
</div>
<div class="ulist">
<ul>
<li>
<p>手动编辑NFS配置文件/etc/exports</p>
</li>
<li>
<p>使用命令exportfs，通过命令行配置</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="__etc_exports文件">/etc/exports文件</h5>

</div>
<div class="sect4">
<h5 id="_语法规则">语法规则</h5>
<div class="paragraph">
<p>/etc/exports配置的文件系统将按照指定的选项共享到远程主机。此文件遵循以下语法规则：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>忽略空白行</p>
</li>
<li>
<p>以井号开始的行为注释</p>
</li>
<li>
<p>以反斜线续行</p>
</li>
<li>
<p>每行配置共享一个文件系统</p>
</li>
<li>
<p>共享的文件系统后面，所有授权主机列表必须以空格跟分隔</p>
</li>
<li>
<p>每个主机的选项必须直接放在主机标识符之后的圆括号里，主机和第一个圆括号之间不能有任何空格</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_结构">结构</h5>
<div class="paragraph">
<p>每行配置遵循以下结构：</p>
</div>
<div class="paragraph">
<p><code>export host(options)</code></p>
</div>
<div class="paragraph">
<p>上述结构采用了以下变量：</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">export</dt>
<dd>
<p>被共享的目录</p>
</dd>
<dt class="hdlist1">host</dt>
<dd>
<p>目录被共享给指定的主机或网络</p>
</dd>
<dt class="hdlist1">options</dt>
<dd>
<p>被主机使用的选项</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>可以指定多个主机，并为每个主机指定选项。为了在同一行配置多个的主机(以空格分隔)，每个主机名后都将各自的选项填写在圆括号中，如：</p>
</div>
<div class="paragraph">
<p><code>export host1(options1) host2(options2) host3(options3)</code></p>
</div>
<div class="paragraph">
<p>关于指定主机名的方法，请查阅 "<a href="#hostname_formats">主机名格式</a>"。</p>
</div>
<div class="paragraph">
<p>最简单的/etc/exports文件仅仅指定共享的目录和允许的主机，比如：</p>
</div>
<div class="exampleblock">
<div class="title">Example 1. /etc/exports文件</div>
<div class="content">
<div class="paragraph">
<p>/exported/directory bob.example.com</p>
</div>
</div>
</div>
<div class="paragraph">
<p>此时，bob.example.com(主机)能够挂载来自NFS服务端的/exported/directory/。因为此时没有选项被指定，NFS将使用默认设置。</p>
</div>
</div>
<div class="sect4">
<h5 id="_选项">选项</h5>
<div class="dlist">
<dl>
<dt class="hdlist1">ro(默认值)</dt>
<dd>
<p>允许读取数据。共享的文件系统只读，远程主机不能修改此文件系统上的数据</p>
</dd>
<dt class="hdlist1">rw</dt>
<dd>
<p>允许读写数据</p>
</dd>
<dt class="hdlist1">sync(默认值)</dt>
<dd>
<p>同步写入。在读写模式下，上一个请求写完数据到硬盘之前，NFS服务端不能回应请求。要启用异步写入，需要指定 <code>async</code> 选项</p>
</dd>
<dt class="hdlist1">wdelay(默认值)</dt>
<dd>
<p>假如NFS服务端认为另一个写请求已迫在眉睫，它会延迟写入数据到硬盘。这样能够提升性能，因为此策略能够减少写命令必须访问
硬盘的次数。要禁止这个选项，需要指定 <code>no_wdelay</code> 选项。 只有 <code>sync</code> 选项指定时， <code>no_wdelay</code> 才有效</p>
</dd>
<dt class="hdlist1">root_squash(默认值)</dt>
<dd>
<p>这个选项可以防止root用户远程连接(相对于本地)，从而具有root权限。相反，NFS服务端会映射root用户到匿名用户(nfsnobody)。这样有效的“压缩”远程root用户的权利为最低权限的本地用户，防止在远程服务器上出现可能未经授权的写操作</p>
</dd>
<dt class="hdlist1">all_squash</dt>
<dd>
<p>远程用户(包括root)映射为匿名用户(nfsnobody)</p>
</dd>
<dt class="hdlist1">anonuid</dt>
<dd>
<p>远程访问的用户映射为指定的本地用户</p>
</dd>
<dt class="hdlist1">anongid</dt>
<dd>
<p>远程访问的用户组映射为指定的本地用户组</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="hostname_formats">主机名格式</h5>
<div class="paragraph">
<p>主机可以为以下形式：</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">单个机器</dt>
<dd>
<p>完全形式的域名(能够被服务器解析的)，主机名(能够被服务器解析的)或者IP地址</p>
</dd>
<dt class="hdlist1">使用通配符指定多个机器</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>使用星号(*)或者问号(?)匹配一个字符串</p>
</li>
<li>
<p>通配符不能被用于IP地址</p>
</li>
<li>
<p>如果递归DNS查找失败，通配符会尽可能的工作</p>
</li>
<li>
<p>当在完全形式的域名中指定通配符时，通配符不会包含点(.)。比如，*.example.com包括one.example.com，但不包括one.two.example.com</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">IP网络</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>格式a.b.c.d/z，a.b.c.d是网络，z是子网掩码位(比如，192.168.0.0/24)</p>
</li>
<li>
<p>格式a.b.c.d/netmask，a.b.c.d是网络，netmask是子网掩码(比如，192.168.100.8/255.255.255.04)</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">网络组</dt>
<dd>
<p>格式@group-name，group-name表示NIS网络组名称。更多关于NIS的信息，请访问  <a href="https://www.freebsd.org/doc/zh_CN.UTF-8/books/handbook/network-nis.html">网络信息服务</a></p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_客户端文档">10.2.2. 客户端文档</h4>
<div class="paragraph">
<p>请访问  <a href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Storage_Administration_Guide/s1-nfs-client-config-options.html">常见的NFS挂载选项</a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_配置_3">10.3. 配置</h3>
<div class="sect3">
<h4 id="_服务端_server3">10.3.1. 服务端(Server3)</h4>
<div class="listingblock">
<div class="title">Server3执行</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">chown -R nginx:nginx /data
uid=`id -u nginx`
gid=`id -g nginx`
cat &lt;&lt; EOF &gt; /etc/exports
/data 11.11.11.0/24(rw,sync,all_squash,anonuid=$uid,anongid=$gid) 12.12.12.0/24(rw,sync,all_squash,anonuid=$uid,anongid=$gid) 14.14.14.0/24(rw,sync,all_squash,anonuid=$uid,anongid=$gid)
EOF

service rpcbind start
service nfs start</code></pre>
</div>
</div>
<div class="paragraph">
<p>显示NFS服务端的共享列表</p>
</div>
<div class="listingblock">
<div class="title">Server3输出</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-console" data-lang="console">---
# showmount -e
Export list for Server3:
/data 14.14.14.0/24,12.12.12.0/24,11.11.11.0/24
---</code></pre>
</div>
</div>
<div class="paragraph">
<p>显示以上结果，表示成功。</p>
</div>
</div>
<div class="sect3">
<h4 id="_server2客户端">10.3.2. Server2客户端</h4>
<div class="paragraph">
<p>显示NFS服务端的共享列表</p>
</div>
<div class="listingblock">
<div class="title">Server2输出</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-console" data-lang="console"># showmount -e 12.12.12.90
Export list for 12.12.12.90:
/data 14.14.14.0/24,12.12.12.0/24,11.11.11.0/24</code></pre>
</div>
</div>
<div class="paragraph">
<p>挂载NFS共享目录/data到本地/nfs</p>
</div>
<div class="listingblock">
<div class="title">Server2执行</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">mkdir /nfs
echo "12.12.12.90:/data  /nfs   nfs4      noatime,nolock,intr,bg,tcp     0 0" &gt;&gt;/etc/fstab
mount -a</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>最重要的是这两个参数：</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">bg</dt>
<dd>
<p>后台挂载。常见的情况是，CentOS开机过程中，可能网络有问题无法连接NFS服务端。此时，如果没指定bg，开机过程会卡很久</p>
</dd>
<dt class="hdlist1">tcp</dt>
<dd>
<p>使用TCP协议挂载NFS。因为UDP协议允许丢包，可能会导致NFS数据丢失或不稳定。相反，TCP协议会校验接收的包数据是否完整有效</p>
</dd>
</dl>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_server6_7客户端">10.3.3. Server6&amp;7客户端</h4>
<div class="paragraph">
<p>显示NFS服务端的共享列表</p>
</div>
<div class="listingblock">
<div class="title">Server6输出</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-console" data-lang="console"># showmount -e 11.11.11.90
Export list for 11.11.11.90:
/data 14.14.14.0/24,12.12.12.0/24,11.11.11.0/24</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Server7输出</div>
<div class="content">
<pre># showmount -e 14.14.14.90
Export list for 14.14.14.90:
/data 14.14.14.0/24,12.12.12.0/24,11.11.11.0/24</pre>
</div>
</div>
<div class="paragraph">
<p>挂载NFS共享目录/data到本地/nfs</p>
</div>
<div class="listingblock">
<div class="title">Server6执行</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">mkdir /nfs
chown -R nginx:nginx /nfs
echo "11.11.11.90:/data  /nfs   nfs4      noatime,nolock,intr,bg,tcp     0 0" &gt;&gt;/etc/fstab
mount -a</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Server7执行</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">mkdir /nfs
chown -R nginx:nginx /nfs
echo "14.14.14.90:/data  /nfs   nfs4      noatime,nolock,intr,bg,tcp     0 0" &gt;&gt;/etc/fstab
mount -a</code></pre>
</div>
</div>
<div class="paragraph">
<p>检查是否挂载成功</p>
</div>
<div class="listingblock">
<div class="title">Server6输出</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-console" data-lang="console"># df -h
Filesystem         Size  Used Avail Use% Mounted on
/dev/sda1           48G  2.0G   44G   5% /
tmpfs              246M     0  246M   0% /dev/shm
/dev/sdb1          493G   70M  467G   1% /data
/dev/sda2          444G   70M  422G   1% /data2
11.11.11.90:/data  1.4T   70M  1.3T   1% /nfs</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Server7输出</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-console" data-lang="console"># df -h
Filesystem         Size  Used Avail Use% Mounted on
/dev/sda1           48G  2.0G   44G   5% /
tmpfs              246M     0  246M   0% /dev/shm
/dev/sdb1          493G   70M  467G   1% /data
/dev/sda2          444G   70M  422G   1% /data2
14.14.14.90:/data  1.4T   70M  1.3T   1% /nfs</code></pre>
</div>
</div>
<div class="paragraph">
<p>看到/nfs已经挂载成功。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_测试_6">10.4. 测试</h3>
<div class="sect3">
<h4 id="_检查挂载">10.4.1. 检查挂载</h4>
<div class="paragraph">
<p>在Server2&amp;6&amp;7上执行 <code>df -h|grep '/nfs'</code></p>
</div>
<div class="listingblock">
<div class="title">Server2输出</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-console" data-lang="console"># df -h|grep '/nfs'
12.12.12.90:/data  1.4T   70M  1.3T   1% /nfs</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Server6输出</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-console" data-lang="console"># df -h|grep '/nfs'
11.11.11.90:/data  1.4T   70M  1.3T   1% /nfs</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Server7输出</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-console" data-lang="console"># df -h|grep '/nfs'
14.14.14.90:/data  1.4T   70M  1.3T   1% /nfs</code></pre>
</div>
</div>
<div class="paragraph">
<p>看到/nfs，则表示已经挂载成功。</p>
</div>
</div>
<div class="sect3">
<h4 id="_读写文件">10.4.2. 读写文件</h4>
<div class="listingblock">
<div class="title">Server2&amp;6&amp;7执行</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">dd if=/dev/zero of=/nfs/`hostname`.file bs=1024 count=10000</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
"bs=1024 count=10000" 表示建立10M大小的空文件。
为了测试千兆网线的性能，可以修改为"bs=1024 count=1000000"，建立1G的文件。
在建立完毕后，会显示"xxx MB/秒"的字样，基本可以确定网线速度。
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Server2输出</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-console" data-lang="console"># dd if=/dev/zero of=/nfs/`hostname`.file bs=1024 count=10000
记录了10000+0 的读入
记录了10000+0 的写出
10240000字节(10 MB)已复制，0.169929 秒，60.3 MB/秒</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Server6输出</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-console" data-lang="console"># dd if=/dev/zero of=/nfs/`hostname`.file bs=1024 count=10000
记录了10000+0 的读入
记录了10000+0 的写出
10240000字节(10 MB)已复制，0.372033 秒，27.5 MB/秒</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Server7输出</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-console" data-lang="console"># dd if=/dev/zero of=/nfs/`hostname`.file bs=1024 count=10000
记录了10000+0 的读入
记录了10000+0 的写出
10240000字节(10 MB)已复制，0.602732 秒，17.0 MB/秒</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>因为本书测试集群是在虚拟机上测试的，显示的文件读写速度和真实集群是不一致的。</p>
</div>
<div class="paragraph">
<p>虚拟机是"60.3 MB/秒"、"27.5 MB/秒"或"17.0 MB/秒"，而真实集群(千兆网线)则会是"100.0 MB/秒"、"120.0 MB/秒"或"125.0 MB/秒"
等。</p>
</div>
<div class="paragraph">
<p>千兆网线传输文件的理论值是1000/8=125MB/秒。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>最终，Server3的/data目录和Server2&amp;6&amp;7的/nfs目录会显示同样的内容。</p>
</div>
<div class="listingblock">
<div class="title">Server3输出</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-console" data-lang="console"># ls /data
Server2.file  Server6.file  Server7.file  lost+found</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Server2&amp;6&amp;7输出</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-console" data-lang="console"># ls /nfs
lost+found  Server2.file  Server6.file  Server7.file</code></pre>
</div>
</div>
<div class="paragraph">
<p>至此，已经测试完毕。</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_备份_2">11. 备份</h2>
<div class="sectionbody">
<div class="paragraph">
<p>为了降低学习难度，本书仅演示基于文件系统的同机房异机备份。</p>
</div>
<div class="paragraph">
<p>一般情况下，建议基于文件系统备份即可。对于数据安全要求非常高的情况，肯定是基于硬件和文件系统混合备份，冷&amp;热备份也同时进行。</p>
</div>
<div class="sect2">
<h3 id="_常见的备份方式">11.1. 常见的备份方式</h3>
<div class="sect3">
<h4 id="_备份存储方式">11.1.1. 备份存储方式</h4>
<div class="paragraph">
<p>按照备份存储方式，可以分为：</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">基于硬件</dt>
<dd>
<p>一般使用RAID阵列卡+硬盘做RAID 1/5，多个硬盘中损坏一个也不会导致数据丢失</p>
<div class="ulist">
<ul>
<li>
<p>优点</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>实时备份</p>
</li>
<li>
<p>与操作系统无关</p>
</li>
<li>
<p>硬盘损坏时，如服务器支持热插拔硬盘，可以实现在线替换硬盘</p>
</li>
<li>
<p>服务器管理人员仅仅需要懂RAID阵列卡的设置，即可完成设置操作</p>
</li>
<li>
<p>备份操作不会占用硬盘IO</p>
</li>
</ol>
</div>
</li>
<li>
<p>缺点</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>结构无法横向扩展</p>
</li>
<li>
<p>数据无法迁移</p>
</li>
<li>
<p>占用硬盘容量。比如，2个500G的硬盘，最终只能使用500G</p>
</li>
<li>
<p>RAID阵列卡需要占用一定的预算</p>
</li>
<li>
<p>恢复备份时，需要RAID相关的专业人士。需要进行恢复操作时，千万别让第三方人员代为操作。出现误操作导致数据丢失的风险非常大</p>
</li>
<li>
<p>断电等故障可能导致RAID硬件信息丢失，出现RAID无法识别等情况。此时，只能高价请专业数据恢复公司恢复数据</p>
</li>
</ol>
</div>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">基于文件系统</dt>
<dd>
<p>通过文件复制方式，进行本机或者异机(异地)备份。<br>
一般使用rsync做文件复制备份，而MySQL常见情况是使用主从复制做备份(虽然是基于MySQL本身的功能，实际上也是基于文件系统)。</p>
<div class="ulist">
<ul>
<li>
<p>优点</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>灵活可控</p>
</li>
<li>
<p>低成本</p>
</li>
<li>
<p>简单</p>
</li>
<li>
<p>数据对人类可见，文件或目录等信息一目了然，确认数据完整性非常方便</p>
</li>
<li>
<p>不会占用硬盘容量</p>
</li>
<li>
<p>可以无限横向扩展，随意增删备份服务器</p>
</li>
<li>
<p>数据可以随意迁移</p>
</li>
</ol>
</div>
</li>
<li>
<p>缺点</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>对服务器管理人员要求较高</p>
</li>
<li>
<p>需要各个工具配合完成备份，可能出现更多的故障点</p>
</li>
<li>
<p>备份或恢复数据时，如果文件非常多或者很大，短时间内会占用硬盘IO</p>
</li>
<li>
<p>恢复备份时，需要非常熟悉各个环节，同第一点</p>
</li>
</ol>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_备份操作方式">11.1.2. 备份操作方式</h4>
<div class="paragraph">
<p>按照备份操作方式，可以分为：</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">热备份</dt>
<dd>
<p>一般是指实时备份，不会丢失数据的备份操作。</p>
</dd>
<dt class="hdlist1">冷备份</dt>
<dd>
<p>一般是指非实时的备份，会丢失数据的备份操作。比如，冷备份是一天备份一次。如果从冷备份恢复数据，则会丢失上次备份到下次备份之间的数据，也就是一天之内的数据。</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_备份策略">11.2. 备份策略</h3>
<div class="paragraph">
<p>重要的数据，一般指数据库。必须冷&amp;热备份同时进行。比如MySQL服务器，需要同时做冷&amp;热备份。</p>
</div>
<div class="paragraph">
<p>不太重要的数据，一般指网页文件。仅仅做冷备份即可。比如NFS存储服务器以及Nginx服务器上的网页文件，一般做冷备份即可。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">NFS</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>冷备份，由固定时间执行脚本实现</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Nginx</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>冷备份，由固定时间执行脚本实现</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">MySQL</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>热备份，由MySQL的主-主复制+日志实现</p>
</li>
<li>
<p>冷备份，由固定时间执行脚本实现</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_设置备份">11.3. 设置备份</h3>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
更多关于rsyncd.conf的信息，请访问 <a href="https://download.samba.org/pub/rsync/rsyncd.conf.html">Manual page rsyncd.conf</a> 。
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_nfs存储备份源">11.3.1. NFS存储备份源</h4>
<div class="listingblock">
<div class="title">Server3执行</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">rm -f /etc/rsyncd.conf
wget -c http://fifilyu.github.io/halcpgb/file/Server3.etc.rsyncd.conf -O /etc/rsyncd.conf

rsync --daemon
echo "/usr/bin/rsync --daemon" &gt;&gt;/etc/rc.local</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_nginx文件备份源">11.3.2. Nginx文件备份源</h4>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
假设所有的动态网页文件全部存放在 <code>/data</code> 目录。
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Server7执行</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">rm -f /etc/rsyncd.conf
wget -c http://fifilyu.github.io/halcpgb/file/Server7.etc.rsyncd.conf -O /etc/rsyncd.conf

rsync --daemon
echo "/usr/bin/rsync --daemon" &gt;&gt;/etc/rc.local</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_mysql冷备份源">11.3.3. MySQL冷备份源</h4>
<div class="listingblock">
<div class="title">Server5执行</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">rm -f /etc/rsyncd.conf /opt/bak_db_dump.sh /opt/bak_db_binlog.sh
wget -c http://fifilyu.github.io/halcpgb/file/Server5.etc.rsyncd.conf -O /etc/rsyncd.conf
wget -c http://fifilyu.github.io/halcpgb/file/Server5.opt.bak_db_dump.sh -O /opt/bak_db_dump.sh
wget -c http://fifilyu.github.io/halcpgb/file/Server5.opt.bak_db_binlog.sh -O /opt/bak_db_binlog.sh

chmod 700 /opt/bak_db_dump.sh /opt/bak_db_binlog.sh

rsync --daemon
echo "/usr/bin/rsync --daemon" &gt;&gt;/etc/rc.local

# bak_db_binlog.sh必须在bak_db_dump.sh之前运行
echo "1 1 * * * /bin/sh /opt/bak_db_binlog.sh" &gt;&gt;/var/spool/cron/root

echo "1 2 * * 0 /bin/sh /opt/bak_db_dump.sh" &gt;&gt;/var/spool/cron/root</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_备份客户端">11.3.4. 备份客户端</h4>
<div class="listingblock">
<div class="title">Server2执行</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">rm -f /opt/rsync_all_bak.sh
wget -c http://fifilyu.github.io/halcpgb/file/Server2.opt.rsync_all_bak.sh -O /opt/rsync_all_bak.sh

chmod 700 /opt/rsync_all_bak.sh

echo "1 5 * * * /bin/sh /opt/rsync_all_bak.sh" &gt;&gt;/var/spool/cron/root</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_确认设置">11.3.5. 确认设置</h4>
<div class="sect4">
<h5 id="_rsync服务">Rsync服务</h5>
<div class="ulist">
<ul>
<li>
<p>检查Rsync服务是否成功启动</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Server3&amp;5&amp;7执行</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">ss -lpn|grep rsync</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Server3输出</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-console" data-lang="console"># ss -lpn|grep rsync
LISTEN     0      5               12.12.12.90:873                      *:*      users:(("rsync",1573,4))</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Server5输出</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-console" data-lang="console"># ss -lpn|grep rsync
LISTEN     0      5               10.10.10.102:873                      *:*      users:(("rsync",1560,4))</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Server7输出</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-console" data-lang="console"># ss -lpn|grep rsync
LISTEN     0      5               10.10.10.202:873                      *:*      users:(("rsync",1233,4))</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_计划任务">计划任务</h5>
<div class="ulist">
<ul>
<li>
<p>检查MySQL服务器定时备份是否设置</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Server5执行</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">crontab -l|egrep '(bak_db_binlog.sh)|(bak_db_dump.sh)'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Server5输出</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-console" data-lang="console"># crontab -l|egrep '(bak_db_binlog.sh)|(bak_db_dump.sh)'
1 1 * * * /bin/sh /opt/bak_db_binlog.sh
1 2 * * 0 /bin/sh /opt/bak_db_dump.sh</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>检查备份服务器定时备份是否设置</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Server2执行</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">crontab -l|egrep rsync_all_bak.sh</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Server2输出</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-console" data-lang="console"># crontab -l|egrep rsync_all_bak.sh
1 5 * * * /bin/sh /opt/rsync_all_bak.sh</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_使用备份">11.4. 使用备份</h3>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
整个恢复过程看似简单，但实际操作会问题多多。限于篇幅，本书没有详细解读。
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
在生产服务器上，需要从备份数据恢复时，必须在专业人士的协助下操作，或由专业人士直接操作。操作前，一定要备份当前数据避免"次生灾害"。
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_恢复mysql备份">11.4.1. 恢复MySQL备份</h4>
<div class="paragraph">
<p>MySQL备份是导出(mysqldump)所有MySQL数据库数据为SQL文件，加上binlog日志来实现的。比如操作失误删除部分数据，要从备份恢复。请按照以下步骤操作：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>备份当前MySQL的所有数据(通过mysqldump导出为SQL文件或者直接备份MySQL数据库物理文件)</p>
</li>
<li>
<p>修改当前MySQL服务器的配置文件my.cnf，禁用binlog，并重启MySQL</p>
</li>
<li>
<p>关闭所有主从复制</p>
</li>
<li>
<p>使用 <code>scp</code> 或 <code>rsync</code> 命令，将SQL文件传输到MySQL服务器，然后执行 <code>mysql -uroot -prootpassword &lt; 备份文件名.sql</code> (导入时间和备份文件的大小成正比)</p>
</li>
<li>
<p>使用 <code>mysqlbinlog 日志文件1 日志文件2 &#8230;&#8203; 日志文件N |mysql -uroot -prootpassword</code> ，按照日志回滚数据</p>
</li>
<li>
<p>日志回滚完毕后，启用binlog参数，重启MySQL，最后启动主从复制</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>以上步骤并非标准，需要根据实际情况调整。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
更多关于binlog解释，请访问 <a href="https://dev.mysql.com/doc/refman/5.0/en/binary-log.html">The Binary Log</a>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_恢复web数据">11.4.2. 恢复Web数据</h4>
<div class="paragraph">
<p>Web数据备份包括NFS储存文件和Nginx服务器文件。按照以下步骤操作：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>停止所有Web相关的服务，包括Nginx、LVS以及Keepalived等等，使服务器处于完全空闲状态</p>
</li>
<li>
<p>使用 <code>rsync</code> 命令，将文件从备份服务器传输到NFS储存服务器或Nginx服务器。比如NFS服务的 <code>/data/image</code> 目录丢失部分图片文件，直接使用 <code>rsync</code> 将备份服务器的 <code>/data/backup/nfs/source/image</code> 目录增量同步丢失的文件到NFS服务的 <code>/data/image</code> 目录即可</p>
</li>
<li>
<p>启动所有Web相关服务</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>以上步骤并非标准，需要根据实际情况调整。</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_防火墙">12. 防火墙</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_选择_3">12.1. 选择</h3>
<div class="paragraph">
<p>我们选择操作系统提供的iptables软件作为防火墙。</p>
</div>
<div class="paragraph">
<p><strong>为什么不使用硬件防火墙？</strong></p>
</div>
<div class="paragraph">
<p>在日常的企业活动中，一般企业没有能力或者需求自己购买硬件防火墙，然后托管到电信机房中。
一般意义上的服务器安全都交由操作系统提供的防火墙软件来防护。
而电信机房托管的硬件防火墙更多时候，充当的是一个“阀门”。专门处理明显异常的网络流量，比如 <a href="https://en.wikipedia.org/wiki/Denial-of-service_attack">DDoS攻击</a>、  <a href="https://en.wikipedia.org/wiki/SYN_flood">SYN攻击</a>、 <a href="https://en.wikipedia.org/wiki/UDP_flood_attack">UDP攻击</a>等等。往往这样的攻击都伴随超大的网络带宽输入，导致服务器甚至电信机房网络瘫痪。一般要防御这种类型的攻击，要购买硬件防火墙、超大的网络带宽(非常昂贵)以及托管服务，是非常不划算的。</p>
</div>
<div class="paragraph">
<p>所以，一般情况下，明显异常的网络流量都不需要自己管理，默认由电信公司提供最基本的网络稳定保障。我们也就专注服务器本身的事情。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
除非一次性向电信公司购买(租用)一个机柜(12台1U服务器)的托管业务。否则，是没有机会在电信机房上自己的交换机或防火墙之类的设备的。
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_设置">12.2. 设置</h3>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
如果配置错误，被DROP的访问会记录在日志文件 <code>/var/log/iptables.log</code> 中。通过日志文件的内容排除错误。
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_server1_2">12.2.1. Server1&amp;2</h4>
<div class="listingblock">
<div class="title">Server1&amp;2执行</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">#添加系统日志设置，将iptables日志写入/var/log/iptables.log
echo "kern.warning /var/log/iptables.log" &gt;&gt; /etc/rsyslog.conf
service rsyslog restart

#清空iptables默认链表规则
iptables -F

#放行本机网络
iptables -A INPUT -i lo -j ACCEPT
iptables -A INPUT -s 10.10.10.70 -j ACCEPT
iptables -A INPUT -s 10.10.10.80 -j ACCEPT

#放行千兆网线组建的内网网段
iptables -A INPUT -s 12.12.12.0/24 -j ACCEPT

#允许任何人SSH(22)端口
iptables -A INPUT -p tcp --dport 22 -j ACCEPT

#允许公网访问本机的HTTP(80)端口
iptables -A INPUT -p tcp --dport 80 -j ACCEPT

#允许访问本机以外的HTTP(80)、Rsync(873)以及MySQL(3306)端口
iptables -A INPUT -p tcp --sport 80 -j ACCEPT
iptables -A INPUT -p tcp --sport 873 -j ACCEPT
iptables -A INPUT -p tcp --sport 3306 -j ACCEPT

#允许Nginx服务器访问MySQL(3306)端口
iptables -A INPUT -p tcp -s 10.10.10.201 --dport 3306 -j ACCEPT
iptables -A INPUT -p tcp -s 10.10.10.202 --dport 3306 -j ACCEPT

#将DROP信息写入日志文件/var/log/iptables.log
iptables -A INPUT -p tcp -j LOG --log-prefix "*** TCP-INPUT-DROP *** " --log-tcp-options --log-ip-options

#除以上规则外，公网不能访问本机任何TCP端口
iptables -A INPUT -p tcp -j DROP

#保存iptables规则到默认配置文件
service iptables save</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_server3">12.2.2. Server3</h4>
<div class="listingblock">
<div class="title">Server3执行</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">#添加系统日志设置，将iptables日志写入/var/log/iptables.log
echo "kern.warning /var/log/iptables.log" &gt;&gt; /etc/rsyslog.conf
service rsyslog restart

#清空iptables默认链表规则
iptables -F

#放行本机网络
iptables -A INPUT -i lo -j ACCEPT
iptables -A INPUT -s 10.10.10.201 -j ACCEPT
iptables -A INPUT -s 10.10.10.202 -j ACCEPT

#放行千兆网线组建的内网网段
iptables -A INPUT -s 11.11.11.0/24 -j ACCEPT
iptables -A INPUT -s 12.12.12.0/24 -j ACCEPT

#允许任何人SSH(22)端口
iptables -A INPUT -p tcp --dport 22 -j ACCEPT

#允许备份服务器访问Rsync(873)端口
iptables -A INPUT -p tcp -s 10.10.10.80 --dport 873 -j ACCEPT

#允许访问本机以外的HTTP(80)端口
iptables -A INPUT -p tcp --sport 80 -j ACCEPT

#将DROP信息写入日志文件/var/log/iptables.log
iptables -A INPUT -p tcp -j LOG --log-prefix "*** TCP-INPUT-DROP *** " --log-tcp-options --log-ip-options

#除以上规则外，公网不能访问本机任何TCP端口
iptables -A INPUT -p tcp -j DROP

#保存iptables规则到默认配置文件
service iptables save</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_server4_5_2">12.2.3. Server4&amp;5</h4>
<div class="listingblock">
<div class="title">Server4&amp;5执行</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">#添加系统日志设置，将iptables日志写入/var/log/iptables.log
echo "kern.warning /var/log/iptables.log" &gt;&gt; /etc/rsyslog.conf
service rsyslog restart

#清空iptables默认链表规则
iptables -F

#放行本机网络
iptables -A INPUT -i lo -j ACCEPT
iptables -A INPUT -s 10.10.10.101 -j ACCEPT
iptables -A INPUT -s 10.10.10.102 -j ACCEPT

#放行千兆网线组建的内网网段
iptables -A INPUT -s 13.13.13.0/24 -j ACCEPT

#允许任何人SSH(22)端口
iptables -A INPUT -p tcp --dport 22 -j ACCEPT

#允许备份服务器访问Rsync(873)端口
iptables -A INPUT -p tcp -s 10.10.10.80 --dport 873 -j ACCEPT

#允许访问本机以外的HTTP(80)端口
iptables -A INPUT -p tcp --sport 80 -j ACCEPT

#允许WEB相关的服务器访问MySQL(3306)端口
iptables -A INPUT -p tcp -s 10.10.10.70 --dport 3306 -j ACCEPT
iptables -A INPUT -p tcp -s 10.10.10.80 --dport 3306 -j ACCEPT
iptables -A INPUT -p tcp -s 10.10.10.100 --dport 3306 -j ACCEPT
iptables -A INPUT -p tcp -s 10.10.10.201 --dport 3306 -j ACCEPT
iptables -A INPUT -p tcp -s 10.10.10.202 --dport 3306 -j ACCEPT

#将DROP信息写入日志文件/var/log/iptables.log
iptables -A INPUT -p tcp -j LOG --log-prefix "*** TCP-INPUT-DROP *** " --log-tcp-options --log-ip-options

#除以上规则外，公网不能访问本机任何TCP端口
iptables -A INPUT -p tcp -j DROP

#保存iptables规则到默认配置文件
service iptables save</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_server6_7_2">12.2.4. Server6&amp;7</h4>
<div class="listingblock">
<div class="title">Server6&amp;7执行</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">#添加系统日志设置，将iptables日志写入/var/log/iptables.log
echo "kern.warning /var/log/iptables.log" &gt;&gt; /etc/rsyslog.conf
service rsyslog restart

#清空iptables默认链表规则
iptables -F

#放行本机网络
iptables -A INPUT -i lo -j ACCEPT
iptables -A INPUT -s 10.10.10.201 -j ACCEPT
iptables -A INPUT -s 10.10.10.202 -j ACCEPT

#允许任何人SSH(22)端口
iptables -A INPUT -p tcp --dport 22 -j ACCEPT

#允许备份服务器访问Rsync(873)端口
iptables -A INPUT -p tcp -s 10.10.10.80 --dport 873 -j ACCEPT

#禁止访问本机公网IP上监听的HTTP(80)端口，仅允许访问本机内网IP上监听的HTTP(80)端口
iptables -A INPUT -p tcp -s 192.168.1.200 --dport 80 -j DROP
iptables -A INPUT -p tcp -d 192.168.1.202 --dport 80 -j DROP
iptables -A INPUT -p tcp --dport 80 -j ACCEPT

#允许访问本机以外的HTTP(80)和MySQL(3306)端口
iptables -A INPUT -p tcp --sport 80 -j ACCEPT
iptables -A INPUT -p tcp --sport 3306 -j ACCEPT

#将DROP信息写入日志文件/var/log/iptables.log
iptables -A INPUT -p tcp -j LOG --log-prefix "*** TCP-INPUT-DROP *** " --log-tcp-options --log-ip-options

#除以上规则外，公网不能访问本机任何TCP端口
iptables -A INPUT -p tcp -j DROP

#保存iptables规则到默认配置文件
service iptables save</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 1.0.28<br>
Last updated 2016-10-09 13:10:38 CST
</div>
</div>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.9.1/styles/github.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.9.1/highlight.min.js"></script>
<script>hljs.initHighlighting()</script>
</body>
</html>